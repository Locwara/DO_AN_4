
  {% extends 'dashboard/index.html' %}
{% load chat_extras %}
  {% block extra_css %}
    <style>
        :root {
            --primary-color: #6366f1;
            --primary-dark: #4f46e5;
            --secondary-color: #8b5cf6;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --dark-color: #1f2937;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-500: #6b7280;
            --gray-700: #374151;
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-secondary: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            --border-radius: 16px;
            --border-radius-lg: 24px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--gradient-primary);
            min-height: 100vh;
            color: var(--dark-color);
        }

        .navbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: none;
            box-shadow: var(--shadow);
        }

      

        .main-container {
            min-height: calc(100vh - 80px);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem 1rem;
        }

        .upload-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(255, 255, 255, 0.2);
            max-width: 1000px;
            width: 100%;
            overflow: hidden;
        }

        .upload-header {
            background: var(--gradient-primary);
            color: white;
            padding: 2rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .upload-header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) rotate(0deg); }
            33% { transform: translate(20px, -20px) rotate(120deg); }
            66% { transform: translate(-10px, 10px) rotate(240deg); }
        }

        .upload-header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            position: relative;
            z-index: 2;
        }

        .upload-header p {
            font-size: 1.1rem;
            opacity: 0.9;
            position: relative;
            z-index: 2;
        }

        .upload-body {
            padding: 3rem 2rem;
        }

        .progress-steps {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 3rem;
        }

        .step {
            display: flex;
            align-items: center;
            font-weight: 500;
        }

        .step-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .step.active .step-circle {
            background: var(--primary-color);
            color: white;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.2);
        }

        .step.completed .step-circle {
            background: var(--success-color);
            color: white;
        }

        .step:not(.active):not(.completed) .step-circle {
            background: var(--gray-200);
            color: var(--gray-500);
        }

        .step-divider {
            width: 60px;
            height: 2px;
            background: var(--gray-200);
            margin: 0 1rem;
        }

        .step.completed + .step-divider {
            background: var(--success-color);
        }

        .form-section {
            background: white;
            border-radius: var(--border-radius);
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--gray-200);
        }

        .section-header {
            display: flex;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--gray-100);
        }

        .section-header h3 {
            font-weight: 600;
            color: var(--dark-color);
            margin: 0;
        }

        .section-icon {
            width: 40px;
            height: 40px;
            background: var(--primary-color);
            color: white;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            font-weight: 500;
            color: var(--dark-color);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
        }

        .form-label .required {
            color: var(--danger-color);
            margin-left: 0.25rem;
        }

        .form-control, .form-select {
            border: 2px solid var(--gray-200);
            border-radius: var(--border-radius);
            padding: 0.75rem 1rem;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
            outline: none;
        }

        .form-control.is-invalid, .form-select.is-invalid {
            border-color: var(--danger-color);
        }

        .form-control.is-valid, .form-select.is-valid {
            border-color: var(--success-color);
        }

        .invalid-feedback {
            color: var(--danger-color);
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        .valid-feedback {
            color: var(--success-color);
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        .form-text {
            color: var(--gray-500);
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        .tag-input-container {
            position: relative;
        }

        .tag-display {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .tag {
            background: var(--primary-color);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tag-remove {
            cursor: pointer;
            font-size: 0.75rem;
            opacity: 0.7;
        }

        .tag-remove:hover {
            opacity: 1;
        }

        .document-type-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .document-type-card {
            border: 2px solid var(--gray-200);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .document-type-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .document-type-card.selected {
            border-color: var(--primary-color);
            background: rgba(99, 102, 241, 0.1);
        }

        .document-type-card i {
            font-size: 2rem;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .selected-files-summary {
            background: var(--gray-100);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .file-preview {
            display: flex;
            align-items: center;
            padding: 1rem;
            background: white;
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            box-shadow: var(--shadow);
        }

        .file-icon {
            width: 40px;
            height: 40px;
            background: var(--primary-color);
            color: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 1rem;
        }

        .btn {
            font-weight: 500;
            padding: 0.75rem 2rem;
            border-radius: var(--border-radius);
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
            color: white;
        }

        .btn-secondary {
            background: var(--gray-200);
            color: var(--dark-color);
        }

        .btn-secondary:hover {
            background: var(--gray-300);
            transform: translateY(-1px);
            color: var(--dark-color);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .action-buttons {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 3rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .loading-spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .btn.loading .loading-spinner {
            display: inline-block;
        }

        .btn.loading .btn-text {
            display: none;
        }

        /* Select2 Styling */
        .select2-container--default .select2-selection--single {
            border: 2px solid var(--gray-200);
            border-radius: var(--border-radius);
            height: 50px;
            padding: 0.5rem 0;
        }

        .select2-container--default .select2-selection--single .select2-selection__rendered {
            line-height: 36px;
            padding-left: 1rem;
        }

        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 48px;
            right: 1rem;
        }

        .select2-dropdown {
            border: 2px solid var(--primary-color);
            border-radius: var(--border-radius);
        }

        .select2-container--default .select2-results__option--highlighted[aria-selected] {
            background-color: var(--primary-color);
        }

        @media (max-width: 768px) {
            .upload-container {
                margin: 0;
                border-radius: 0;
                min-height: 100vh;
            }

            .upload-header h1 {
                font-size: 2rem;
            }

            .upload-body {
                padding: 2rem 1rem;
            }

            .form-section {
                padding: 1.5rem;
            }

            .progress-steps {
                flex-direction: column;
                gap: 1rem;
            }

            .step-divider {
                width: 2px;
                height: 30px;
                transform: rotate(90deg);
            }

            .action-buttons {
                flex-direction: column-reverse;
                align-items: stretch;
            }

            .btn {
                justify-content: center;
            }

            .document-type-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>

    {% endblock %}
    {% block content %}
    <!-- Navbar -->
     <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Main Container -->
    <div class="main-container">
        <div class="upload-container">
            <!-- Header -->
            <div class="upload-header">
                <h1><i class="fas fa-edit me-3"></i>Điền Thông Tin Tài Liệu</h1>
                <p>Hoàn tất thông tin để chia sẻ tài liệu với cộng đồng</p>
            </div>

            <!-- Body -->
            <div class="upload-body">
                <!-- Progress Steps -->
                <div class="progress-steps">
                    <div class="step completed">
                        <div class="step-circle"><i class="fas fa-check"></i></div>
                        <span>Chọn Tài Liệu</span>
                    </div>
                    <div class="step-divider"></div>
                    <div class="step active">
                        <div class="step-circle">2</div>
                        <span>Điền Thông Tin</span>
                    </div>
                </div>

                <!-- Selected Files Summary -->
                <div class="selected-files-summary">
                    <h5><i class="fas fa-files me-2"></i>Tài liệu đã chọn:</h5>
                    <div id="filesSummary">
                        <div class="loading-spinner">
                            <i class="fas fa-spinner fa-spin"></i> Đang tải thông tin file...
                        </div>
                    </div>
                </div>

                <!-- Upload Form -->
                <form id="uploadForm" novalidate>
                    {% csrf_token %}
                    
                    <!-- Document Basic Info -->
                    <div class="form-section">
                        <div class="section-header">
                            <div class="section-icon">
                                <i class="fas fa-info-circle"></i>
                            </div>
                            <h3>Thông tin cơ bản</h3>
                        </div>

                        <div class="row">
                            <div class="col-lg-8">
                                <div class="form-group">
                                    <label class="form-label">
                                        Tiêu đề tài liệu <span class="required">*</span>
                                    </label>
                                    <input type="text" class="form-control" id="documentTitle" name="title" required>
                                    <div class="form-text">VD: "Bài tập Toán cao cấp - Chương 1: Giới hạn"</div>
                                    <div class="invalid-feedback">Vui lòng nhập tiêu đề tài liệu</div>
                                </div>
                            </div>
                            <div class="col-lg-4">
                                <div class="form-group">
                                    <label class="form-label">Loại tài liệu <span class="required">*</span></label>
                                    <div class="document-type-grid">
                                        {% for value, label in document_types %}
                                        <div class="document-type-card" data-type="{{ value }}">
                                            <i class="fas fa-{% if value == 'textbook' %}book{% elif value == 'exercise' %}pencil-alt{% elif value == 'exam' %}file-alt{% elif value == 'thesis' %}graduation-cap{% elif value == 'lecture' %}chalkboard-teacher{% else %}folder{% endif %}"></i>
                                            <div>{{ label }}</div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                    <input type="hidden" id="documentType" name="document_type" required>
                                    <div class="invalid-feedback">Vui lòng chọn loại tài liệu</div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Mô tả tài liệu</label>
                            <textarea class="form-control" id="documentDescription" name="description" rows="3" placeholder="Mô tả nội dung, chương, bài học... (không bắt buộc)"></textarea>
                            <div class="form-text">Mô tả chi tiết giúp người khác dễ dàng tìm thấy tài liệu của bạn</div>
                        </div>
                    </div>

                    <!-- University and Course Info -->
                    <div class="form-section">
                        <div class="section-header">
                            <div class="section-icon">
                                <i class="fas fa-university"></i>
                            </div>
                            <h3>Thông tin học tập</h3>
                        </div>

                        <div class="row">
                            <div class="col-lg-6">
                                <div class="form-group">
                                    <label class="form-label">
                                        Trường Đại học <span class="required">*</span>
                                    </label>
                                    <select class="form-select" id="university" name="university" required>
                                        <option value="">-- Chọn trường đại học --</option>
                                    </select>
                                    <div class="invalid-feedback">Vui lòng chọn trường đại học</div>
                                    <div class="form-text">
                                        <div class="loading-text" id="universityLoading" style="display: none;">
                                            <i class="fas fa-spinner fa-spin me-1"></i>Đang tải danh sách trường...
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="form-group">
                                    <label class="form-label">
                                        Môn học <span class="required">*</span>
                                    </label>
                                    <div class="input-group">
                                        <select class="form-select" id="course" name="course" required disabled>
                                            <option value="">-- Chọn trường đại học trước --</option>
                                        </select>
                                        <button class="btn btn-outline-secondary" type="button" id="addCourseBtn" disabled>
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                    <div class="invalid-feedback">Vui lòng chọn môn học</div>
                                    <div class="form-text">
                                        <div class="loading-text" id="courseLoading" style="display: none;">
                                            <i class="fas fa-spinner fa-spin me-1"></i>Đang tải danh sách môn học...
                                        </div>
                                        <div id="noCourseMessage" style="display: none;">
                                            <i class="fas fa-info-circle me-1"></i>
                                            Chưa có môn học nào cho trường này. 
                                            <a href="#" id="addCourseLink">Thêm môn học mới</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-lg-6">
                                <div class="form-group">
                                    <label class="form-label">Năm học</label>
                                    <select class="form-select" id="academicYear" name="academic_year">
                                        <option value="">-- Chọn năm học --</option>
                                        {% for value, label in academic_years %}
                                        <option value="{{ value }}">{{ label }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="form-group">
                                    <label class="form-label">Học kỳ</label>
                                    <select class="form-select" id="semester" name="semester">
                                        <option value="">-- Chọn học kỳ --</option>
                                        {% for value, label in semesters %}
                                        <option value="{{ value }}">{{ label }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tags and Keywords -->
                    <div class="form-section">
                        <div class="section-header">
                            <div class="section-icon">
                                <i class="fas fa-tags"></i>
                            </div>
                            <h3>Tags và từ khóa</h3>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Tags</label>
                            <div class="tag-input-container">
                                <input type="text" class="form-control" id="tagInput" placeholder="Nhập tag và nhấn Enter (VD: toán, giải tích, bài tập...)">
                                <div class="tag-display" id="tagDisplay"></div>
                            </div>
                            <div class="form-text">Tags giúp phân loại và tìm kiếm tài liệu dễ dàng hơn</div>
                        </div>
                    </div>

                    <!-- Privacy Settings -->
                    <div class="form-section">
                        <div class="section-header">
                            <div class="section-icon">
                                <i class="fas fa-shield-alt"></i>
                            </div>
                            <h3>Cài đặt quyền riêng tư</h3>
                        </div>

                        <div class="row">
                            <div class="col-lg-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="isPublic" name="is_public" checked>
                                    <label class="form-check-label" for="isPublic">
                                        <strong>Công khai</strong><br>
                                        <small class="text-muted">Tài liệu có thể được tìm kiếm và xem bởi mọi người</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-lg-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="agreeTerms" name="agree_terms" required>
                                    <label class="form-check-label" for="agreeTerms">
                                        <strong>Đồng ý điều khoản <span class="required">*</span></strong><br>
                                        <small class="text-muted">Tôi xác nhận tài liệu không vi phạm bản quyền và tuân thủ <a href="#" target="_blank">điều khoản sử dụng</a></small>
                                    </label>
                                    <div class="invalid-feedback">Vui lòng đồng ý với điều khoản sử dụng</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="action-buttons">
                        <button type="button" class="btn btn-secondary" id="backBtn">
                            <i class="fas fa-arrow-left me-2"></i>Quay Lại
                        </button>
                        <button type="submit" class="btn btn-primary" id="submitBtn">
                            <span class="btn-text">
                                <i class="fas fa-cloud-upload-alt me-2"></i>Tải Lên Tài Liệu
                            </span>
                            <div class="loading-spinner"></div>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Course Modal -->
    <div class="modal fade" id="addCourseModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Thêm môn học mới</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addCourseForm">
                        <div class="mb-3">
                            <label class="form-label">Tên môn học <span class="required">*</span></label>
                            <input type="text" class="form-control" id="newCourseName" required>
                            <div class="invalid-feedback">Vui lòng nhập tên môn học</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Mã môn học <span class="required">*</span></label>
                            <input type="text" class="form-control" id="newCourseCode" required>
                            <div class="invalid-feedback">Vui lòng nhập mã môn học</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Mô tả môn học</label>
                            <textarea class="form-control" id="newCourseDescription" rows="3" placeholder="Mô tả ngắn về môn học (không bắt buộc)"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-primary" id="saveCourseBtn">
                        <span class="btn-text">
                            <i class="fas fa-plus me-1"></i>Thêm môn học
                        </span>
                        <div class="loading-spinner"></div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
    <script>
        let selectedTags = [];
        let tempFiles = [];

        // Initialize page
        $(document).ready(function() {
            checkTemporaryFiles();
            initializeSelectors();
            bindEvents();
            loadUniversities();
        });

        // Check if we have temporary files from step 1
        function checkTemporaryFiles() {
            const sessionKey = sessionStorage.getItem('tempUploadSession');
            
            if (!sessionKey) {
                showAlert('Không tìm thấy file đã upload. Vui lòng quay lại bước 1.', 'warning');
                setTimeout(() => {
                    window.location.href = '{% url "upload_step1" %}';
                }, 2000);
                return;
            }

            // Get temporary file info from server
            fetch('{% url "api_temp_files_info" %}', {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.files && data.files.length > 0) {
                    tempFiles = data.files;
                    displayFilesSummary();
                } else {
                    showAlert('Không tìm thấy file tạm thời. Vui lòng upload lại.', 'warning');
                    setTimeout(() => {
                        window.location.href = '{% url "upload_step1" %}';
                    }, 2000);
                }
            })
            .catch(error => {
                console.error('Error getting temp files:', error);
                showAlert('Lỗi tải thông tin file. Vui lòng thử lại.', 'error');
            });
        }

        function displayFilesSummary() {
            const container = document.getElementById('filesSummary');
            container.innerHTML = '';

            tempFiles.forEach(file => {
                const fileName = file.original_name || file.name || 'Unknown file';
                const fileSize = file.size || 0;
                const fileExtension = fileName.split('.').pop().toLowerCase();
                const fileIcon = getFileIcon(fileExtension);

                const fileDiv = document.createElement('div');
                fileDiv.className = 'file-preview';
                fileDiv.innerHTML = `
                    <div class="file-icon">
                        <i class="fas fa-${fileIcon}"></i>
                    </div>
                    <div class="file-details">
                        <h6>${fileName}</h6>
                        <small>${formatFileSize(fileSize)} • ${fileExtension.toUpperCase()}</small>
                    </div>
                `;
                container.appendChild(fileDiv);
            });
        }

        function initializeSelectors() {
            $('#university').select2({
                placeholder: '-- Chọn trường đại học --',
                allowClear: true,
                theme: 'bootstrap-5',
                width: '100%',
                minimumInputLength: 0,
                ajax: {
                    url: '{% url "api_universities" %}',
                    dataType: 'json',
                    delay: 250,
                    data: function(params) {
                        return {
                            search: params.term || '',
                            page: params.page || 1
                        };
                    },
                    processResults: function(data) {
                        if (data.success) {
                            return {
                                results: data.data.map(uni => ({
                                    id: uni.id,
                                    text: uni.display_name || `${uni.name} (${uni.short_name})`
                                }))
                            };
                        }
                        return { results: [] };
                    },
                    cache: true
                }
            });

            $('#course').select2({
                placeholder: '-- Chọn môn học --',
                allowClear: true,
                theme: 'bootstrap-5',
                width: '100%'
            });
        }

        function bindEvents() {
            // Document type selection
            $('.document-type-card').click(function() {
                $('.document-type-card').removeClass('selected');
                $(this).addClass('selected');
                $('#documentType').val($(this).data('type'));
                validateField($('#documentType')[0]);
            });

            // University change
            $('#university').on('change', function() {
                const universityId = $(this).val();
                loadCourses(universityId);
                $('#course').val('').trigger('change');
                validateField(this);
                
                // Enable/disable add course button
                $('#addCourseBtn').prop('disabled', !universityId);
            });

            // Course change
            $('#course').on('change', function() {
                validateField(this);
            });

            // Tag input
            $('#tagInput').keypress(function(e) {
                if (e.which === 13) {
                    e.preventDefault();
                    addTag($(this).val().trim());
                    $(this).val('');
                }
            });

            // Form validation on input
            $('#documentTitle, #agreeTerms').on('input change', function() {
                validateField(this);
            });

            // Add course button
            $('#addCourseBtn').click(function() {
                if (!$('#university').val()) {
                    showAlert('Vui lòng chọn trường đại học trước', 'warning');
                    return;
                }
                $('#addCourseModal').modal('show');
            });

            // Add course link (when no courses available)
            $(document).on('click', '#addCourseLink', function(e) {
                e.preventDefault();
                $('#addCourseModal').modal('show');
            });

            // Save new course
            $('#saveCourseBtn').click(function() {
                saveNewCourse();
            });

            // Back button
            $('#backBtn').click(function() {
                window.location.href = '{% url "upload_step1" %}';
            });

            // Form submission
            $('#uploadForm').submit(function(e) {
                e.preventDefault();
                submitForm();
            });

            // Modal events
            $('#addCourseModal').on('show.bs.modal', function() {
                $('#addCourseForm')[0].reset();
                $('.is-invalid').removeClass('is-invalid');
            });
        }

        function loadUniversities() {
            $('#universityLoading').show();
            
            // Load initial universities
            $.get('{% url "api_universities" %}', { search: '' })
                .done(function(data) {
                    if (data.success) {
                        const universitySelect = $('#university');
                        universitySelect.empty().append('<option value="">-- Chọn trường đại học --</option>');
                        
                        data.data.forEach(uni => {
                            universitySelect.append(new Option(uni.display_name, uni.id));
                        });
                    }
                })
                .fail(function() {
                    showAlert('Lỗi tải danh sách trường đại học', 'error');
                })
                .always(function() {
                    $('#universityLoading').hide();
                });
        }

        function loadCourses(universityId) {
            const courseSelect = $('#course');
            const noCourseMessage = $('#noCourseMessage');
            const courseLoading = $('#courseLoading');

            courseSelect.empty().prop('disabled', true);
            noCourseMessage.hide();

            if (!universityId) {
                courseSelect.append('<option value="">-- Chọn trường đại học trước --</option>');
                return;
            }

            courseLoading.show();

            $.get('{% url "api_courses" %}', { university: universityId })
                .done(function(data) {
                    if (data.success) {
                        if (data.data && data.data.length > 0) {
                            courseSelect.append('<option value="">-- Chọn môn học --</option>');
                            data.data.forEach(course => {
                                courseSelect.append(new Option(course.display_name, course.id));
                            });
                            courseSelect.prop('disabled', false);
                            noCourseMessage.hide();
                        } else {
                            courseSelect.append('<option value="">-- Chưa có môn học nào --</option>');
                            noCourseMessage.show();
                        }
                    } else {
                        showAlert('Lỗi tải danh sách môn học: ' + (data.message || 'Unknown error'), 'error');
                    }
                })
                .fail(function() {
                    showAlert('Lỗi tải danh sách môn học', 'error');
                })
                .always(function() {
                    courseLoading.hide();
                });
        }

        function saveNewCourse() {
            const name = $('#newCourseName').val().trim();
            const code = $('#newCourseCode').val().trim();
            const description = $('#newCourseDescription').val().trim();
            const universityId = $('#university').val();

            // Validate form
            let isValid = true;
            if (!name) {
                $('#newCourseName').addClass('is-invalid');
                isValid = false;
            } else {
                $('#newCourseName').removeClass('is-invalid');
            }

            if (!code) {
                $('#newCourseCode').addClass('is-invalid');
                isValid = false;
            } else {
                $('#newCourseCode').removeClass('is-invalid');
            }

            if (!universityId) {
                showAlert('Vui lòng chọn trường đại học trước', 'warning');
                return;
            }

            if (!isValid) return;

            const saveCourseBtn = $('#saveCourseBtn');
            saveCourseBtn.addClass('loading').prop('disabled', true);

            const courseData = {
                university: universityId,
                name: name,
                code: code,
                description: description
            };

            $.ajax({
                url: '{% url "api_courses" %}',
                method: 'POST',
                headers: {
                    'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
                },
                data: JSON.stringify(courseData),
                contentType: 'application/json',
                success: function(data) {
                    if (data.success) {
                        showAlert(data.message || 'Môn học đã được thêm thành công!', 'success');
                        
                        // Add new course to select and select it
                        const courseSelect = $('#course');
                        courseSelect.append(new Option(data.data.display_name, data.data.id, true, true));
                        courseSelect.prop('disabled', false).trigger('change');
                        
                        // Hide no course message if it was showing
                        $('#noCourseMessage').hide();
                        
                        // Close modal
                        $('#addCourseModal').modal('hide');
                    } else {
                        showAlert(data.message || 'Lỗi thêm môn học', 'error');
                    }
                },
                error: function(xhr, status, error) {
                    let errorMessage = 'Có lỗi xảy ra khi thêm môn học';
                    try {
                        const response = JSON.parse(xhr.responseText);
                        errorMessage = response.message || errorMessage;
                    } catch (e) {}
                    showAlert(errorMessage, 'error');
                },
                complete: function() {
                    saveCourseBtn.removeClass('loading').prop('disabled', false);
                }
            });
        }

        function addTag(tagText) {
            if (!tagText || selectedTags.includes(tagText)) {
                return;
            }

            selectedTags.push(tagText);
            displayTags();
        }

        function removeTag(index) {
            selectedTags.splice(index, 1);
            displayTags();
        }

        function displayTags() {
            const container = $('#tagDisplay');
            container.empty();

            selectedTags.forEach((tag, index) => {
                const tagElement = $(`
                    <span class="tag">
                        ${tag}
                        <span class="tag-remove" onclick="removeTag(${index})">×</span>
                    </span>
                `);
                container.append(tagElement);
            });
        }

        function validateField(field) {
            const $field = $(field);
            const value = $field.val();
            let isValid = true;

            // Remove existing validation classes
            $field.removeClass('is-valid is-invalid');

            // Required field validation
            if (field.required && !value) {
                isValid = false;
            }

            // Specific validations
            if (field.id === 'documentType' && !value) {
                isValid = false;
            }

            // Apply validation classes
            if (field.required || value) {
                $field.addClass(isValid ? 'is-valid' : 'is-invalid');
            }

            return isValid;
        }

        function validateForm() {
            let isValid = true;
            const requiredFields = ['#documentTitle', '#university', '#course', '#documentType', '#agreeTerms'];

            requiredFields.forEach(selector => {
                const field = $(selector)[0];
                if (field && !validateField(field)) {
                    isValid = false;
                }
            });

            // Check document type selection
            if (!$('#documentType').val()) {
                isValid = false;
                showAlert('Vui lòng chọn loại tài liệu', 'warning');
            }

            return isValid;
        }

        function submitForm() {
            if (!validateForm()) {
                return;
            }

            const submitBtn = $('#submitBtn');
            submitBtn.addClass('loading').prop('disabled', true);

            // Create FormData
            const formData = new FormData();
            
            formData.append('title', $('#documentTitle').val());
            formData.append('description', $('#documentDescription').val());
            formData.append('document_type', $('#documentType').val());
            formData.append('university', $('#university').val());
            formData.append('course', $('#course').val());
            formData.append('academic_year', $('#academicYear').val());
            formData.append('semester', $('#semester').val());
            formData.append('is_public', $('#isPublic').is(':checked') ? 'true' : 'false');
            formData.append('tags', selectedTags.join(','));

            // Get CSRF token
            const csrfToken = $('[name=csrfmiddlewaretoken]').val();

            // Submit to finalize upload API
            fetch('{% url "api_finalize_upload" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Clear stored data
                    sessionStorage.removeItem('tempUploadSession');
                    localStorage.removeItem('uploadFormData');
                    
                    showAlert('Tải lên thành công!', 'success');
                    
                    // Redirect to success page
                    const docs = data.data && data.data.documents ? data.data.documents.join(',') : '';
                    setTimeout(() => {
                        window.location.href = '{% url "upload_success" %}?docs=' + docs;
                    }, 1000);
                } else {
                    showAlert('Lỗi: ' + (data.message || 'Unknown error'), 'error');
                }
            })
            .catch(error => {
                console.error('Submit error:', error);
                showAlert('Có lỗi xảy ra: ' + error.message, 'error');
            })
            .finally(() => {
                submitBtn.removeClass('loading').prop('disabled', false);
            });
        }

        // Utility functions
        function getFileIcon(extension) {
            const iconMap = {
                'pdf': 'file-pdf',
                'doc': 'file-word',
                'docx': 'file-word',
                'ppt': 'file-powerpoint',
                'pptx': 'file-powerpoint',
                'txt': 'file-alt',
                'xls': 'file-excel',
                'xlsx': 'file-excel',
                'jpg': 'file-image',
                'jpeg': 'file-image',
                'png': 'file-image',
                'gif': 'file-image'
            };
            return iconMap[extension] || 'file';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function showAlert(message, type = 'info') {
            // Create alert element
            const alertClass = {
                'success': 'alert-success',
                'error': 'alert-danger',
                'warning': 'alert-warning',
                'info': 'alert-info'
            };

            const alertIcon = {
                'success': 'fa-check-circle',
                'error': 'fa-exclamation-circle',
                'warning': 'fa-exclamation-triangle',
                'info': 'fa-info-circle'
            };

            const alertElement = $(`
                <div class="alert ${alertClass[type]} alert-dismissible fade show position-fixed" 
                     style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
                    <i class="fas ${alertIcon[type]} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `);

            // Add to body
            $('body').append(alertElement);

            // Auto remove after 5 seconds
            setTimeout(() => {
                alertElement.alert('close');
            }, 5000)
        }

        // Make removeTag function global for onclick handler
        window.removeTag = removeTag;
    </script>
{% endblock %}