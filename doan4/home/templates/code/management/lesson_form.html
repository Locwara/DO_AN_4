{% extends 'dashboard/index.html' %}
{% load static %}

{% block extra_css %}
<style>
.lesson-form-container {
  max-width: 1200px;
  margin: 0 auto;
}

.form-section {
  background: white;
  border-radius: 16px;
  padding: 2rem;
  margin-bottom: 2rem;
  box-shadow: 0 4px 20px rgba(0,0,0,0.08);
}

.section-title {
  font-size: 1.25rem;
  font-weight: 600;
  margin-bottom: 1.5rem;
  color: #1f2937;
  border-bottom: 2px solid #e5e7eb;
  padding-bottom: 0.5rem;
}

.help-text {
  background: #eff6ff;
  border-left: 4px solid #3b82f6;
  padding: 1rem;
  border-radius: 0 8px 8px 0;
  margin-bottom: 1rem;
  font-size: 0.9rem;
}

.test-case-item, .hint-item {
  background: #f9fafb;
  border: 1px solid #e5e7eb;
  border-radius: 8px;
  padding: 1rem;
  margin-bottom: 1rem;
}

.test-case-item .form-label, .hint-item .form-label {
  font-weight: 600;
  font-size: 0.9rem;
  margin-bottom: 0.5rem;
}

.btn-add-more {
  background: #10b981;
  color: white;
  border: none;
  border-radius: 8px;
  padding: 0.5rem 1rem;
}

.btn-remove {
  background: #ef4444;
  color: white;
  border: none;
  border-radius: 8px;
  padding: 0.25rem 0.75rem;
  font-size: 0.875rem;
}

.code-editor {
  font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
  font-size: 14px;
  background: #f8fafc;
}

.rich-editor {
  min-height: 200px;
}
</style>
{% endblock %}

{% block content %}
<div class="lesson-form-container">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h3 mb-1">{{ page_title }}</h1>
      <p class="text-muted">Khóa học: <strong>{{ course.title }}</strong></p>
    </div>
    <div>
      <a href="{% url 'course_management_edit' course.id %}" class="btn btn-outline-secondary me-2">
        <i class="fas fa-arrow-left me-2"></i>
        Quay lại
      </a>
    </div>
  </div>

  <form method="post" id="lessonForm">
    {% csrf_token %}
    <!-- Hidden field to set lesson_type to coding by default -->
    <input type="hidden" name="lesson_type" value="coding">
    
    <div class="row">
      <div class="col-lg-8">
        <!-- Basic Information -->
        <div class="form-section">
          <h3 class="section-title">
            <i class="fas fa-info-circle text-primary me-2"></i>
            Thông Tin Cơ Bản
          </h3>
          
          <div class="help-text">
            <i class="fas fa-lightbulb me-2"></i>
            <strong>Hướng dẫn:</strong> Điền tên bài học và mô tả ngắn. Bài học sẽ mặc định là bài tập lập trình.
          </div>
          
          <div class="row">
            <div class="col-12 mb-3">
              <label for="{{ form.title.id_for_label }}" class="form-label">
                Tên bài học *
              </label>
              {{ form.title }}
              {% if form.title.errors %}
                <div class="text-danger small mt-1">{{ form.title.errors.0 }}</div>
              {% endif %}
            </div>
            
            <div class="col-12 mb-3">
              <label for="{{ form.description.id_for_label }}" class="form-label">
                Mô tả bài học
              </label>
              {{ form.description }}
              <small class="text-muted">Mô tả ngắn gọn về nội dung bài học</small>
              {% if form.description.errors %}
                <div class="text-danger small mt-1">{{ form.description.errors.0 }}</div>
              {% endif %}
            </div>
            
            <div class="col-md-6 mb-3">
              <label for="{{ form.estimated_time.id_for_label }}" class="form-label">
                Thời gian ước tính (phút)
              </label>
              {{ form.estimated_time }}
              <small class="text-muted">Thời gian học viên cần để hoàn thành</small>
              {% if form.estimated_time.errors %}
                <div class="text-danger small mt-1">{{ form.estimated_time.errors.0 }}</div>
              {% endif %}
            </div>
            
            <div class="col-md-6 mb-3">
              <label for="{{ form.points_reward.id_for_label }}" class="form-label">
                Điểm thưởng *
              </label>
              {{ form.points_reward }}
              <small class="text-muted">Điểm học viên nhận khi hoàn thành</small>
              {% if form.points_reward.errors %}
                <div class="text-danger small mt-1">{{ form.points_reward.errors.0 }}</div>
              {% endif %}
            </div>
          </div>
        </div>
        
        <!-- Theory Content -->
        <div class="form-section">
          <h3 class="section-title">
            <i class="fas fa-book text-primary me-2"></i>
            Nội Dung Lý Thuyết
          </h3>
          
          <div class="help-text">
            <i class="fas fa-lightbulb me-2"></i>
            <strong>Hướng dẫn:</strong> Viết nội dung lý thuyết cho bài học. Bạn có thể sử dụng văn bản đơn giản hoặc HTML.
          </div>
          
          <div class="mb-3">
            <label for="{{ form.theory_content.id_for_label }}" class="form-label">
              Nội dung lý thuyết
            </label>
            {{ form.theory_content }}
            <small class="text-muted">Giải thích khái niệm, cú pháp, ví dụ...</small>
            {% if form.theory_content.errors %}
              <div class="text-danger small mt-1">{{ form.theory_content.errors.0 }}</div>
            {% endif %}
          </div>
        </div>
        
        <!-- Coding Exercise -->
        <div class="form-section">
          <h3 class="section-title">
            <i class="fas fa-code text-primary me-2"></i>
            Bài Tập Lập Trình
          </h3>
          
          <div class="help-text">
            <i class="fas fa-lightbulb me-2"></i>
            <strong>Hướng dẫn:</strong> Viết đề bài rõ ràng, cung cấp code mẫu ban đầu và lời giải để tham khảo.
          </div>
          
          <div class="mb-3">
            <label for="{{ form.problem_statement.id_for_label }}" class="form-label">
              Đề bài
            </label>
            {{ form.problem_statement }}
            <small class="text-muted">Mô tả bài toán: yêu cầu, input, output, ví dụ...</small>
            {% if form.problem_statement.errors %}
              <div class="text-danger small mt-1">{{ form.problem_statement.errors.0 }}</div>
            {% endif %}
          </div>
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="{{ form.starter_code.id_for_label }}" class="form-label">
                Code mẫu ban đầu
              </label>
              {{ form.starter_code }}
              <small class="text-muted">Code có sẵn cho học viên</small>
              {% if form.starter_code.errors %}
                <div class="text-danger small mt-1">{{ form.starter_code.errors.0 }}</div>
              {% endif %}
            </div>
            
            <div class="col-md-6 mb-3">
              <label for="{{ form.solution_code.id_for_label }}" class="form-label">
                Lời giải mẫu
              </label>
              {{ form.solution_code }}
              <small class="text-muted">Chỉ giáo viên có thể xem</small>
              {% if form.solution_code.errors %}
                <div class="text-danger small mt-1">{{ form.solution_code.errors.0 }}</div>
              {% endif %}
            </div>
          </div>
        </div>
        
        <!-- Test Cases Builder -->
        <div class="form-section">
          <h3 class="section-title">
            <i class="fas fa-check-circle text-primary me-2"></i>
            Test Cases
          </h3>
          
          <div class="help-text">
            <i class="fas fa-lightbulb me-2"></i>
            <strong>Hướng dẫn:</strong> Tạo các test cases để kiểm tra code của học viên. Nếu bài tập không cần input, để trống ô "Input".
          </div>
          
          <div id="testCasesContainer">
            <!-- Test cases will be added here dynamically -->
          </div>
          
          <button type="button" class="btn btn-add-more" onclick="addTestCase()">
            <i class="fas fa-plus me-2"></i>
            Thêm Test Case
          </button>
          
          <!-- Hidden field để lưu JSON -->
          {{ form.test_cases }}
        </div>
        
        <!-- Hints Builder -->
        <div class="form-section">
          <h3 class="section-title">
            <i class="fas fa-lightbulb text-primary me-2"></i>
            Gợi Ý
          </h3>
          
          <div class="help-text">
            <i class="fas fa-lightbulb me-2"></i>
            <strong>Hướng dẫn:</strong> Tạo các gợi ý để giúp học viên khi gặp khó khăn. Gợi ý sẽ hiển thị lần lượt sau mỗi lần thử.
          </div>
          
          <div id="hintsContainer">
            <!-- Hints will be added here dynamically -->
          </div>
          
          <button type="button" class="btn btn-add-more" onclick="addHint()">
            <i class="fas fa-plus me-2"></i>
            Thêm Gợi Ý
          </button>
          
          <!-- Hidden field để lưu JSON -->
          {{ form.hints }}
        </div>
      </div>
      
      <div class="col-lg-4">
        <!-- Lesson Status -->
        {% if lesson %}
        <div class="form-section">
          <h3 class="section-title">
            <i class="fas fa-flag text-primary me-2"></i>
            Trạng Thái
          </h3>
          
          <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <span>Trạng thái:</span>
              <span class="badge bg-{% if lesson.is_published %}success{% else %}warning{% endif %} fs-6">
                {% if lesson.is_published %}
                  <i class="fas fa-check me-1"></i>Published
                {% else %}
                  <i class="fas fa-edit me-1"></i>Draft
                {% endif %}
              </span>
            </div>
          </div>
        </div>
        {% endif %}
        
        <!-- Quick Tips -->
        <div class="form-section">
          <h3 class="section-title">
            <i class="fas fa-question-circle text-primary me-2"></i>
            Mẹo Nhanh
          </h3>
          
          <div class="small">
            <p><strong>✓ Đề bài rõ ràng:</strong></p>
            <ul>
              <li>Mô tả bài toán cụ thể</li>
              <li>Cho ví dụ input/output</li>
              <li>Giải thích ràng buộc</li>
            </ul>
            
            <p><strong>✓ Test Cases:</strong></p>
            <ul>
              <li>Tối thiểu 2-3 test cases</li>
              <li>Bao gồm trường hợp đặc biệt</li>
              <li>Test case đầu tiên nên đơn giản</li>
            </ul>
            
            <p><strong>✓ Gợi Ý:</strong></p>
            <ul>
              <li>Gợi ý từ dễ đến khó</li>
              <li>Không tiết lộ đáp án trực tiếp</li>
              <li>Hướng dẫn cách tiếp cận</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Submit Buttons -->
    <div class="form-section">
      <div class="d-flex justify-content-between">
        <a href="{% url 'course_management_edit' course.id %}" class="btn btn-outline-secondary">
          <i class="fas fa-times me-2"></i>
          Hủy
        </a>
        
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-save me-2"></i>
          {% if lesson %}Cập nhật{% else %}Tạo bài học{% endif %}
        </button>
      </div>
    </div>
  </form>
</div>

<script>
let testCaseCounter = 0;
let hintCounter = 0;

// Initialize from existing data
function initializeTestCases() {
  const testCasesInput = document.getElementById('{{ form.test_cases.id_for_label }}');
  const existingData = testCasesInput.value;
  
  if (existingData && existingData.trim()) {
    try {
      const testCases = JSON.parse(existingData);
      testCases.forEach((tc, index) => {
        addTestCase(tc.input, tc.expected_output);
      });
    } catch (e) {
      console.error('Error parsing test cases:', e);
      // Add 2 empty test cases as default
      addTestCase();
      addTestCase();
    }
  } else {
    // Add 2 empty test cases as default
    addTestCase();
    addTestCase();
  }
}

function initializeHints() {
  const hintsInput = document.getElementById('{{ form.hints.id_for_label }}');
  const existingData = hintsInput.value;
  
  if (existingData && existingData.trim()) {
    try {
      const hints = JSON.parse(existingData);
      hints.forEach((hint, index) => {
        addHint(hint.title, hint.content);
      });
    } catch (e) {
      console.error('Error parsing hints:', e);
      // Add 1 empty hint as default
      addHint();
    }
  } else {
    // Add 1 empty hint as default
    addHint();
  }
}

function addTestCase(inputVal = '', outputVal = '') {
  testCaseCounter++;
  const container = document.getElementById('testCasesContainer');
  
  const div = document.createElement('div');
  div.className = 'test-case-item';
  div.id = `testCase_${testCaseCounter}`;
  div.innerHTML = `
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h6 class="mb-0">Test Case #${testCaseCounter}</h6>
      <button type="button" class="btn btn-remove" onclick="removeTestCase(${testCaseCounter})">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="row">
      <div class="col-md-6 mb-2">
        <label class="form-label">Input (để trống nếu không cần)</label>
        <textarea class="form-control" rows="3" data-tc-input="${testCaseCounter}" placeholder="VD: 5\n10">${inputVal}</textarea>
        <small class="text-muted">Mỗi dòng là một input</small>
      </div>
      <div class="col-md-6 mb-2">
        <label class="form-label">Output mong đợi *</label>
        <textarea class="form-control" rows="3" data-tc-output="${testCaseCounter}" placeholder="VD: 15" required>${outputVal}</textarea>
        <small class="text-muted">Kết quả chính xác</small>
      </div>
    </div>
  `;
  
  container.appendChild(div);
  updateTestCasesJSON();
}

function removeTestCase(id) {
  const elem = document.getElementById(`testCase_${id}`);
  if (elem) {
    elem.remove();
    updateTestCasesJSON();
  }
}

function addHint(titleVal = '', contentVal = '') {
  hintCounter++;
  const container = document.getElementById('hintsContainer');
  
  const div = document.createElement('div');
  div.className = 'hint-item';
  div.id = `hint_${hintCounter}`;
  div.innerHTML = `
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h6 class="mb-0">Gợi Ý #${hintCounter}</h6>
      <button type="button" class="btn btn-remove" onclick="removeHint(${hintCounter})">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="mb-2">
      <label class="form-label">Tiêu đề gợi ý *</label>
      <input type="text" class="form-control" data-hint-title="${hintCounter}" placeholder="VD: Sử dụng vòng lặp" value="${titleVal}" required>
    </div>
    <div class="mb-2">
      <label class="form-label">Nội dung gợi ý *</label>
      <textarea class="form-control" rows="3" data-hint-content="${hintCounter}" placeholder="Hướng dẫn chi tiết..." required>${contentVal}</textarea>
    </div>
  `;
  
  container.appendChild(div);
  updateHintsJSON();
}

function removeHint(id) {
  const elem = document.getElementById(`hint_${id}`);
  if (elem) {
    elem.remove();
    updateHintsJSON();
  }
}

function updateTestCasesJSON() {
  const testCases = [];
  const inputs = document.querySelectorAll('[data-tc-input]');
  const outputs = document.querySelectorAll('[data-tc-output]');
  
  inputs.forEach((input, index) => {
    const output = outputs[index];
    if (output && output.value.trim()) {
      testCases.push({
        input: input.value.trim(),
        expected_output: output.value.trim()
      });
    }
  });
  
  document.getElementById('{{ form.test_cases.id_for_label }}').value = JSON.stringify(testCases);
}

function updateHintsJSON() {
  const hints = [];
  const titles = document.querySelectorAll('[data-hint-title]');
  const contents = document.querySelectorAll('[data-hint-content]');
  
  titles.forEach((title, index) => {
    const content = contents[index];
    if (title.value.trim() && content && content.value.trim()) {
      hints.push({
        title: title.value.trim(),
        content: content.value.trim()
      });
    }
  });
  
  document.getElementById('{{ form.hints.id_for_label }}').value = JSON.stringify(hints);
}

// Update JSON when inputs change
document.addEventListener('DOMContentLoaded', function() {
  initializeTestCases();
  initializeHints();
  
  // Listen for changes
  document.addEventListener('input', function(e) {
    if (e.target.hasAttribute('data-tc-input') || e.target.hasAttribute('data-tc-output')) {
      updateTestCasesJSON();
    }
    if (e.target.hasAttribute('data-hint-title') || e.target.hasAttribute('data-hint-content')) {
      updateHintsJSON();
    }
  });
  
  // Validate before submit
  document.getElementById('lessonForm').addEventListener('submit', function(e) {
    updateTestCasesJSON();
    updateHintsJSON();
    
    const testCasesJSON = document.getElementById('{{ form.test_cases.id_for_label }}').value;
    if (!testCasesJSON || testCasesJSON === '[]') {
      alert('Vui lòng thêm ít nhất 1 test case!');
      e.preventDefault();
      return false;
    }
  });
});
</script>
{% endblock %} 

