{% extends 'dashboard/index.html' %}
{% load static %}

{% block extra_css %}
<style>
:root {
  --primary: #6366f1;
  --success: #10b981;
  --warning: #f59e0b;
  --danger: #ef4444;
  --dark: #1f2937;
  --border: #e5e7eb;
}

.course-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border-radius: 24px;
  padding: 3rem 2rem;
  margin-bottom: 2rem;
  color: white;
  position: relative;
  overflow: hidden;
}

.course-header::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(10px);
  border-radius: 24px;
}

.course-header > * {
  position: relative;
  z-index: 1;
}

.lesson-card {
  background: white;
  border-radius: 16px;
  padding: 1.5rem;
  margin-bottom: 1rem;
  box-shadow: 0 2px 10px rgba(0,0,0,0.05);
  transition: all 0.3s ease;
  border-left: 4px solid transparent;
}

.lesson-card.completed {
  border-left-color: var(--success);
  background: #f0fdf4;
}

.lesson-card.in-progress {
  border-left-color: var(--warning);
  background: #fefbf0;
}

.lesson-card.locked {
  border-left-color: #6b7280;
  background: #f9fafb;
  opacity: 0.7;
}

.lesson-card:hover:not(.locked) {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(0,0,0,0.1);
}

.progress-circle {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 1.1rem;
}

.progress-circle.completed {
  background: var(--success);
  color: white;
}

.progress-circle.in-progress {
  background: var(--warning);
  color: white;
}

.progress-circle.not-started {
  background: #e5e7eb;
  color: #6b7280;
}

.progress-circle.locked {
  background: #6b7280;
  color: white;
}

.lesson-meta {
  display: flex;
  gap: 1rem;
  align-items: center;
  margin-top: 0.5rem;
  font-size: 0.9rem;
  color: #6b7280;
}

.lesson-meta span {
  display: flex;
  align-items: center;
  gap: 0.25rem;
}

.course-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 1rem;
  margin-bottom: 2rem;
}

.stat-card {
  background: white;
  border-radius: 12px;
  padding: 1.5rem;
  text-align: center;
  box-shadow: 0 2px 10px rgba(0,0,0,0.05);
}

.stat-number {
  font-size: 2rem;
  font-weight: bold;
  color: var(--primary);
}

.btn-enroll-large {
  background: var(--primary);
  color: white;
  border: none;
  padding: 1rem 2rem;
  border-radius: 12px;
  font-weight: 600;
  font-size: 1.1rem;
  transition: all 0.3s ease;
  text-decoration: none;
  display: inline-block;
}

.btn-enroll-large:hover {
  background: #4f46e5;
  transform: translateY(-2px);
  color: white;
  text-decoration: none;
}

.btn-continue {
  background: var(--success);
  color: white;
  border: none;
  padding: 1rem 2rem;
  border-radius: 12px;
  font-weight: 600;
  font-size: 1.1rem;
  transition: all 0.3s ease;
  text-decoration: none;
  display: inline-block;
}

.btn-continue:hover {
  background: #059669;
  transform: translateY(-2px);
  color: white;
  text-decoration: none;
}

.overall-progress {
  background: white;
  border-radius: 16px;
  padding: 2rem;
  margin-bottom: 2rem;
  box-shadow: 0 4px 20px rgba(0,0,0,0.08);
}

.progress-bar-large {
  background: #e5e7eb;
  height: 12px;
  border-radius: 6px;
  overflow: hidden;
  margin: 1rem 0;
}

.progress-fill-large {
  background: linear-gradient(90deg, var(--primary) 0%, var(--success) 100%);
  height: 100%;
  transition: width 0.8s ease;
}

@media (max-width: 768px) {
  .course-header {
    padding: 2rem 1rem;
  }
  
  .course-stats {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .lesson-card {
    padding: 1rem;
  }
  
  .lesson-meta {
    flex-wrap: wrap;
    gap: 0.5rem;
  }
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid px-4">
  <!-- Course Header -->
  <div class="course-header">
    <div class="row align-items-center">
      <div class="col-md-8">
        <div class="d-flex align-items-center mb-3">
          <span class="badge bg-light text-dark me-3" style="font-size: 0.9rem;">
            {{ course.language.display_name }}
          </span>
          <span class="badge bg-warning text-dark" style="font-size: 0.9rem;">
            {{ course.get_difficulty_display }}
          </span>
        </div>
        
        <h1 class="h2 mb-3">{{ course.title }}</h1>
        <p class="mb-0 opacity-90">{{ course.description }}</p>
        
        <div class="d-flex align-items-center mt-3">
          <i class="fas fa-user me-2"></i>
          <span>{{ course.created_by.get_full_name|default:course.created_by.username }}</span>
          {% if course.university %}
            <i class="fas fa-university ms-4 me-2"></i>
            <span>{{ course.university.name }}</span>
          {% endif %}
        </div>
      </div>
      
      <div class="col-md-4 text-end">
        {% if enrollment %}
          <div class="mb-3">
            <h5>Progress: {{ enrollment.completion_percentage|floatformat:0 }}%</h5>
            <div class="progress-bar-large">
              <div class="progress-fill-large" style="width: {{ enrollment.completion_percentage }}%"></div>
            </div>
          </div>
          <a href="#lessons" class="btn-continue">
            <i class="fas fa-play me-2"></i>
            Tiếp Tục Học
          </a>
        {% else %}
          <form method="POST" action="{% url 'code_course_enroll' course.slug %}">
            {% csrf_token %}
            {% if course.requires_premium and not user.is_premium %}
              <p class="text-warning mb-3">
                <i class="fas fa-crown me-2"></i>
                Khóa học Premium
              </p>
            {% endif %}
            <button type="submit" class="btn-enroll-large">
              <i class="fas fa-graduation-cap me-2"></i>
              Đăng Ký Khóa Học
            </button>
          </form>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Course Stats -->
  <div class="course-stats">
    <div class="stat-card">
      <div class="stat-number">{{ total_lessons }}</div>
      <div class="text-muted">Bài Học</div>
    </div>
    
    <div class="stat-card">
      <div class="stat-number">{{ course.enrollment_count }}</div>
      <div class="text-muted">Học Viên</div>
    </div>
    
    <div class="stat-card">
      <div class="stat-number">{{ course.estimated_hours|default:"?" }}</div>
      <div class="text-muted">Giờ Học</div>
    </div>
    
    {% if enrollment %}
    <div class="stat-card">
      <div class="stat-number">{{ completed_lessons }}</div>
      <div class="text-muted">Hoàn Thành</div>
    </div>
    {% endif %}
  </div>

  <!-- Overall Progress -->
  {% if enrollment %}
  <div class="overall-progress">
    <h5 class="mb-3">
      <i class="fas fa-chart-line text-primary me-2"></i>
      Tiến Độ Học Tập
    </h5>
    
    <div class="row">
      <div class="col-md-8">
        <div class="progress-bar-large">
          <div class="progress-fill-large" style="width: {{ enrollment.completion_percentage }}%"></div>
        </div>
        <div class="d-flex justify-content-between text-muted">
          <span>{{ completed_lessons }}/{{ total_lessons }} bài hoàn thành</span>
          <span>{{ enrollment.completion_percentage|floatformat:1 }}%</span>
        </div>
      </div>
      
      <div class="col-md-4 text-end">
        <div class="text-muted mb-1">Tổng thời gian học:</div>
        <div class="h5 text-primary">{{ enrollment.total_time_spent }} phút</div>
        <div class="text-muted mb-1">Điểm tích lũy:</div>
        <div class="h5 text-success">{{ enrollment.total_points }} points</div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Lessons List -->
  <div class="mb-4" id="lessons">
    <h4 class="mb-4">
      <i class="fas fa-list-alt text-primary me-2"></i>
      Danh Sách Bài Học
    </h4>
    
    {% if not enrollment %}
    <div class="alert alert-info">
      <i class="fas fa-info-circle me-2"></i>
      Đăng ký khóa học để bắt đầu học và theo dõi tiến độ
    </div>
    {% endif %}
    
    {% for lesson_data in lessons_with_progress %}
    {% with lesson=lesson_data.lesson progress=lesson_data.progress %}
    <div class="lesson-card {% if progress %}{{ progress.status }}{% else %}not-started{% endif %}{% if not enrollment %} locked{% endif %}">
      <div class="d-flex align-items-start">
        <!-- Progress Circle -->
        <div class="progress-circle {% if progress %}{{ progress.status }}{% elif not enrollment %}locked{% else %}not-started{% endif %}">
          {% if progress and progress.status == 'completed' %}
            <i class="fas fa-check"></i>
          {% elif progress and progress.status == 'in_progress' %}
            {{ progress.best_score|floatformat:0 }}%
          {% elif not enrollment %}
            <i class="fas fa-lock"></i>
          {% else %}
            {{ lesson.order_index|add:1 }}
          {% endif %}
        </div>
        
        <!-- Lesson Content -->
        <div class="flex-grow-1 ms-3">
          <h5 class="mb-2">
            {% if enrollment %}
              <a href="{% url 'code_lesson_detail' course.slug lesson.slug %}" 
                 class="text-decoration-none text-dark">
                {{ lesson.title }}
              </a>
            {% else %}
              {{ lesson.title }}
            {% endif %}
          </h5>
          
          {% if lesson.description %}
          <p class="text-muted mb-2">{{ lesson.description|truncatewords:20 }}</p>
          {% endif %}
          
          <div class="lesson-meta">
            <span>
              <i class="fas fa-code"></i>
              {{ lesson.get_lesson_type_display }}
            </span>
            
            {% if lesson.estimated_time %}
            <span>
              <i class="fas fa-clock"></i>
              {{ lesson.estimated_time }} phút
            </span>
            {% endif %}
            
            <span>
              <i class="fas fa-award"></i>
              {{ lesson.points_reward }} points
            </span>
            
            {% if lesson.completion_count %}
            <span>
              <i class="fas fa-users"></i>
              {{ lesson.completion_count }} hoàn thành
            </span>
            {% endif %}
          </div>
          
          <!-- Progress Info -->
          {% if progress %}
          <div class="mt-2">
            {% if progress.status == 'completed' %}
              <small class="text-success">
                <i class="fas fa-check-circle me-1"></i>
                Hoàn thành ngày {{ progress.completed_at|date:"d/m/Y" }}
                • Best: {{ progress.best_score|floatformat:0 }}%
                • {{ progress.attempts_count }} lần thử
              </small>
            {% elif progress.status == 'in_progress' %}
              <small class="text-warning">
                <i class="fas fa-play-circle me-1"></i>
                Đang học • {{ progress.attempts_count }} lần thử
                {% if progress.best_score > 0 %}
                  • Best: {{ progress.best_score|floatformat:0 }}%
                {% endif %}
              </small>
            {% endif %}
          </div>
          {% endif %}
        </div>
        
        <!-- Action Button -->
        <div class="text-end">
          {% if enrollment %}
            {% if progress and progress.status == 'completed' %}
              <a href="{% url 'code_lesson_detail' course.slug lesson.slug %}" 
                 class="btn btn-outline-success btn-sm">
                <i class="fas fa-eye me-1"></i>
                Xem Lại
              </a>
            {% elif progress and progress.status == 'in_progress' %}
              <a href="{% url 'code_lesson_detail' course.slug lesson.slug %}" 
                 class="btn btn-warning btn-sm">
                <i class="fas fa-play me-1"></i>
                Tiếp Tục
              </a>
            {% else %}
              <a href="{% url 'code_lesson_detail' course.slug lesson.slug %}" 
                 class="btn btn-primary btn-sm">
                <i class="fas fa-play me-1"></i>
                Bắt Đầu
              </a>
            {% endif %}
          {% else %}
            <button class="btn btn-outline-secondary btn-sm" disabled>
              <i class="fas fa-lock me-1"></i>
              Cần Đăng Ký
            </button>
          {% endif %}
        </div>
      </div>
    </div>
    {% endwith %}
    {% endfor %}
  </div>

  <!-- Course Info Sidebar -->
  <div class="row mt-5">
    <div class="col-md-8">
      <div class="card border-0 shadow-sm">
        <div class="card-body p-4">
          <h5 class="card-title mb-3">
            <i class="fas fa-info-circle text-primary me-2"></i>
            Thông Tin Khóa Học
          </h5>
          
          <div class="row">
            <div class="col-sm-6 mb-3">
              <strong>Ngôn ngữ:</strong><br>
              <span class="text-muted">{{ course.language.display_name }}</span>
            </div>
            
            <div class="col-sm-6 mb-3">
              <strong>Độ khó:</strong><br>
              <span class="text-muted">{{ course.get_difficulty_display }}</span>
            </div>
            
            <div class="col-sm-6 mb-3">
              <strong>Thời gian ước tính:</strong><br>
              <span class="text-muted">{{ course.estimated_hours|default:"Chưa xác định" }} giờ</span>
            </div>
            
            <div class="col-sm-6 mb-3">
              <strong>Ngày tạo:</strong><br>
              <span class="text-muted">{{ course.created_at|date:"d/m/Y" }}</span>
            </div>
          </div>
          
          {% if course.tags.all %}
          <div class="mt-3">
            <strong>Tags:</strong><br>
            <div class="mt-2">
              {% for tag in course.tags.all %}
              <span class="badge me-2" style="background-color: {{ tag.color }}; color: white;">
                {{ tag.name }}
              </span>
              {% endfor %}
            </div>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
    
    <div class="col-md-4">
      <div class="card border-0 shadow-sm">
        <div class="card-body p-4">
          <h5 class="card-title mb-3">
            <i class="fas fa-user text-primary me-2"></i>
            Giảng Viên
          </h5>
          
          <div class="d-flex align-items-center mb-3">
            {% if course.created_by.avatar %}
              <img src="{{ course.created_by.avatar.url }}" 
                   alt="Avatar" 
                   class="rounded-circle me-3"
                   style="width: 60px; height: 60px; object-fit: cover;">
            {% else %}
              <div class="rounded-circle bg-primary d-flex align-items-center justify-content-center me-3" 
                   style="width: 60px; height: 60px;">
                <i class="fas fa-user text-white"></i>
              </div>
            {% endif %}
            
            <div>
              <h6 class="mb-1">{{ course.created_by.get_full_name|default:course.created_by.username }}</h6>
              {% if course.created_by.bio %}
                <small class="text-muted">{{ course.created_by.bio|truncatewords:10 }}</small>
              {% endif %}
            </div>
          </div>
          
          <!-- Instructor Stats -->
          <div class="text-center">
            <div class="row">
              <div class="col-6">
                <div class="h6 text-primary mb-0">{{ course.created_by.created_courses.count }}</div>
                <small class="text-muted">Khóa học</small>
              </div>
              <div class="col-6">
                <div class="h6 text-success mb-0">{{ course.enrollment_count }}</div>
                <small class="text-muted">Học viên</small>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Quick Actions -->
      <div class="card border-0 shadow-sm mt-3">
        <div class="card-body p-4">
          <h6 class="card-title mb-3">
            <i class="fas fa-bolt text-warning me-2"></i>
            Thao Tác Nhanh
          </h6>
          
          <div class="d-grid gap-2">
            <a href="{% url 'code_courses_list' %}" class="btn btn-outline-primary btn-sm">
              <i class="fas fa-arrow-left me-2"></i>
              Về Danh Sách
            </a>
            
            {% if enrollment %}
            <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary btn-sm">
              <i class="fas fa-chart-line me-2"></i>
              Dashboard
            </a>
            {% endif %}
            
            <button class="btn btn-outline-info btn-sm" onclick="shareToChat()">
              <i class="fas fa-share me-2"></i>
              Chia Sẻ
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function shareToChat() {
  const url = window.location.href;
  const title = '{{ course.title }}';
  
  if (navigator.share) {
    navigator.share({
      title: title,
      text: 'Cùng học khóa ' + title + ' với tôi!',
      url: url
    });
  } else {
    // Fallback: copy to clipboard
    navigator.clipboard.writeText(url).then(() => {
      alert('Đã copy link khóa học!');
    });
  }
}

// Auto-scroll to lessons if coming from enrollment
if (window.location.hash === '#lessons' || document.referrer.includes('enroll')) {
  setTimeout(() => {
    document.getElementById('lessons').scrollIntoView({ behavior: 'smooth' });
  }, 100);
}
</script>
{% endblock %}
