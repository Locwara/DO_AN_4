{% load static %}
{% load custom_filters %}
<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - StudyBot</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    {% block extra_css %}
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: #f8fafc;
        }
        
        .navbar {
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* Hero Section - Clean and Focused */
        .hero-section {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            color: white;
            padding: 60px 0;
            margin-bottom: 40px;
        }
        
        .hero-content {
            max-width: 800px;
            margin: 0 auto;
            text-align: center;
        }
        
        .hero-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }
        
        .hero-subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-bottom: 2rem;
        }
        
        .search-box-large {
            background: white;
            border-radius: 50px;
            padding: 8px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            max-width: 600px;
            margin: 0 auto 2rem;
        }
        
        .search-box-large input {
            border: none;
            padding: 12px 24px;
            font-size: 1.1rem;
        }
        
        .search-box-large input:focus {
            outline: none;
            box-shadow: none;
        }
        
        .search-box-large button {
            border-radius: 50px;
            padding: 12px 32px;
        }
        
        .hero-stats {
            display: flex;
            justify-content: center;
            gap: 3rem;
            margin-top: 2rem;
        }
        
        .hero-stat-item {
            text-align: center;
        }
        
        .hero-stat-number {
            font-size: 2rem;
            font-weight: 700;
            display: block;
        }
        
        .hero-stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        /* Quick Actions - Compact */
        .quick-actions {
            margin-bottom: 40px;
        }
        
        .action-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 2px solid transparent;
            height: 100%;
        }
        
        .action-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border-color: #6366f1;
        }
        
        .action-icon {
            width: 60px;
            height: 60px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            font-size: 1.8rem;
        }
        
        .action-icon.primary { background: #ddd6fe; color: #6366f1; }
        .action-icon.success { background: #dcfce7; color: #16a34a; }
        .action-icon.info { background: #dbeafe; color: #0284c7; }
        .action-icon.warning { background: #fef3c7; color: #d97706; }
        
        .action-title {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 8px;
        }
        
        .action-description {
            color: #6b7280;
            font-size: 0.9rem;
            margin-bottom: 15px;
        }

        /* Custom styles for darker action buttons */
        .action-card .btn-info {
            background-color: #0d6efd; /* Bootstrap's info is #0dcaf0, this is a darker blue */
            border-color: #0d6efd;
            color: white !important;
        }

        .action-card .btn-warning {
            background-color: #e0a800; /* A darker shade of yellow/orange */
            border-color: #e0a800;
            color: white !important;
        }

        
        /* User Stats - Condensed */
        .user-stats-compact {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 40px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            text-align: center;
        }
        
        .stat-item {
            padding: 15px;
            border-radius: 10px;
            background: #f9fafb;
        }
        
        .stat-number {
            font-size: 1.8rem;
            font-weight: 700;
            color: #1f2937;
            display: block;
        }
        
        .stat-label {
            color: #6b7280;
            font-size: 0.85rem;
            margin-top: 5px;
        }
        
        .stat-icon {
            font-size: 1.2rem;
            margin-bottom: 8px;
        }
        
        /* Document Cards */
        .document-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            border: 1px solid #e5e7eb;
            transition: all 0.3s ease;
            cursor: pointer;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .document-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border-color: #6366f1;
        }
        
        .document-thumbnail {
            width: 100%;
            height: 150px;
            background: linear-gradient(45deg, #f3f4f6, #e5e7eb);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            overflow: hidden;
        }
        
        .document-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .file-icon {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            border-radius: 8px;
        }
        
        .file-icon.pdf { background: #fee2e2; color: #dc2626; }
        .file-icon.doc { background: #dbeafe; color: #2563eb; }
        .file-icon.xls { background: #d1fae5; color: #059669; }
        .file-icon.ppt { background: #fed7aa; color: #ea580c; }
        .file-icon.txt { background: #e5e7eb; color: #6b7280; }
        
        .document-title {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 8px;
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .document-meta {
            color: #6b7280;
            font-size: 0.85rem;
            margin-bottom: 10px;
        }
        
        .document-meta i {
            width: 16px;
        }
        
        .document-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: auto;
            padding-top: 15px;
            border-top: 1px solid #e5e7eb;
        }
        
        .document-stats small {
            color: #6b7280;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .document-type-badge {
            display: inline-block;
            background: #ddd6fe;
            color: #7c3aed;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            margin-bottom: 10px;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .status-approved {
            background: #dcfce7;
            color: #166534;
        }
        
        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }
        
        .status-rejected {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        
        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1f2937;
        }
        
        .premium-badge {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .explore-link {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
            text-decoration: none;
            display: block;
        }
        
        .explore-link:hover {
            border-color: #6366f1;
            background: #f9fafb;
            transform: translateY(-2px);
        }
        
        .explore-icon {
            font-size: 3rem;
            color: #6366f1;
            margin-bottom: 15px;
        }
        
        .explore-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 8px;
        }
        
        .explore-description {
            color: #6b7280;
            font-size: 0.9rem;
        }
        
        /* Autocomplete Dropdown */
        .autocomplete-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            max-height: 500px;
            overflow-y: auto;
            z-index: 1000;
            margin-top: 8px;
            opacity: 0;
            transform: translateY(-10px);
            pointer-events: none;
            transition: opacity 0.2s ease, transform 0.2s ease;
        }
        
        .autocomplete-dropdown.show {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }
        
        .autocomplete-section {
            padding: 15px 0;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .autocomplete-section:last-child {
            border-bottom: none;
        }
        
        .autocomplete-header {
            padding: 8px 20px;
            font-size: 0.75rem;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .autocomplete-item {
            padding: 12px 20px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
            position: relative;
        }
        
        .autocomplete-item:hover {
            background: #f3f4f6;
        }
        
        .delete-history-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: transparent;
            color: #9ca3af;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }
        
        .autocomplete-item:hover .delete-history-icon {
            display: flex;
        }
        
        .delete-history-icon:hover {
            background: #fee2e2;
            color: #dc2626;
        }
        
        .autocomplete-icon {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            flex-shrink: 0;
        }
        
        .autocomplete-icon.doc { background: #ddd6fe; color: #7c3aed; }
        .autocomplete-icon.course { background: #dbeafe; color: #0284c7; }
        .autocomplete-icon.uni { background: #dcfce7; color: #16a34a; }
        .autocomplete-icon.history { background: #f3f4f6; color: #6b7280; }
        
        .autocomplete-content {
            flex: 1;
            min-width: 0;
        }
        
        .autocomplete-title {
            font-weight: 500;
            color: #1f2937;
            margin-bottom: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .autocomplete-subtitle {
            font-size: 0.8rem;
            color: #6b7280;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .autocomplete-badge {
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 10px;
            background: #f3f4f6;
            color: #6b7280;
            white-space: nowrap;
        }
        
        .search-box-wrapper {
            position: relative;
        }
        
        .clear-history-btn {
            background: none;
            border: none;
            color: #dc2626;
            cursor: pointer;
            padding: 8px 16px;
            font-size: 0.85rem;
            transition: background 0.2s;
            border-radius: 8px;
            margin: 8px 16px;
            display: block;
            width: calc(100% - 32px);
            text-align: left;
        }
        
        .clear-history-btn:hover {
            background: #fee2e2;
        }
        
        .clear-history-btn i {
            margin-right: 8px;
        }
        

    </style>
    {% endblock %}
</head>
<body>
   
    <!-- Modern Navigation -->
    <nav id="headvip" class="navbar navbar-expand-lg navbar-light bg-white sticky-top" style="box-shadow: 0 2px 10px rgba(0,0,0,0.08); border-bottom: 1px solid #e5e7eb;">
        <div class="container">
            <a class="navbar-brand" href="{% url 'dashboard' %}" style="font-weight: 700; font-size: 1.5rem; color: #6366f1; display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-graduation-cap" style="font-size: 1.8rem;"></i>
                <span>StudyBot</span>
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" style="border: none;">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto ms-lg-4">
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'dashboard' %}" style="font-weight: 500; color: #6366f1; padding: 8px 16px; border-radius: 8px; transition: all 0.2s;" 
                           onmouseover="this.style.background='#f3f4f6'" 
                           onmouseout="this.style.background='transparent'">
                            <i class="fas fa-home"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'documents_list' %}" style="font-weight: 500; color: #1f2937; padding: 8px 16px; border-radius: 8px; transition: all 0.2s;"
                           onmouseover="this.style.background='#f3f4f6'; this.style.color='#6366f1'"
                           onmouseout="this.style.background='transparent'; this.style.color='#1f2937'">
                            <i class="fas fa-file-alt"></i> T√†i li·ªáu
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'code_courses_list' %}" style="font-weight: 500; color: #1f2937; padding: 8px 16px; border-radius: 8px; transition: all 0.2s;"
                           onmouseover="this.style.background='#f3f4f6'; this.style.color='#6366f1'"
                           onmouseout="this.style.background='transparent'; this.style.color='#1f2937'">
                            <i class="fas fa-code"></i> Code with AI
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'ai_image_solver' %}" style="font-weight: 500; color: #1f2937; padding: 8px 16px; border-radius: 8px; transition: all 0.2s;"
                           onmouseover="this.style.background='#f3f4f6'; this.style.color='#6366f1'"
                           onmouseout="this.style.background='transparent'; this.style.color='#1f2937'">
                            <i class="fas fa-robot"></i> AI Chat
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{% url 'chat_rooms_list' %}" style="font-weight: 500; color: #1f2937; padding: 8px 16px; border-radius: 8px; transition: all 0.2s;"
                           onmouseover="this.style.background='#f3f4f6'; this.style.color='#6366f1'"
                           onmouseout="this.style.background='transparent'; this.style.color='#1f2937'">
                            <i class="fas fa-comments"></i> Ph√≤ng Chat
                        </a>
                    </li>
                </ul>
                
                <ul class="navbar-nav align-items-lg-center">
                    {% if user.is_authenticated %}
                        {% if not user.is_premium %}
                        <li class="nav-item me-2">
                            <a href="{% url 'premium_upgrade' %}" class="btn btn-sm" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none; padding: 6px 16px; border-radius: 20px; font-weight: 600; font-size: 0.85rem; transition: transform 0.2s;"
                               onmouseover="this.style.transform='translateY(-2px)'"
                               onmouseout="this.style.transform='translateY(0)'">
                                <i class="fas fa-crown"></i> N√¢ng c·∫•p Premium
                            </a>
                        </li>
                        {% endif %}
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" style="font-weight: 500; color: #1f2937; padding: 8px 12px; border-radius: 8px; display: flex; align-items: center; gap: 8px;">
                                <div style="width: 32px; height: 32px; border-radius: 50%; background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600;">
                                    {{ user.get_full_name|default:user.username|slice:":1"|upper }}
                                </div>
                                <span class="d-none d-lg-inline">{{ user.get_full_name|default:user.username }}</span>
                                {% if user.is_premium %}
                                <span style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: 600;">
                                    <i class="fas fa-crown"></i> Premium
                                </span>
                                {% endif %}
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end" style="border: none; box-shadow: 0 10px 40px rgba(0,0,0,0.1); border-radius: 12px; padding: 8px;">
                                <li><a class="dropdown-item" href="{% url 'profile' %}" style="border-radius: 8px; padding: 10px 16px;"><i class="fas fa-user-edit text-primary"></i> H·ªì s∆°</a></li>
                                {% if user.is_premium %}
                                <li><a class="dropdown-item" href="{% url 'premium_info' %}" style="border-radius: 8px; padding: 10px 16px;"><i class="fas fa-crown text-warning"></i> Th√¥ng tin Premium</a></li>
                                {% if user.premium_expiry %}
                                {% with days_left=user.premium_expiry|days_until %}
                                <li><a class="dropdown-item" href="{% url 'premium_upgrade' %}" style="border-radius: 8px; padding: 10px 16px;">
                                    <i class="fas fa-hourglass-half text-info"></i> 
                                    {% if days_left > 0 %}
                                    C√≤n {{ days_left }} ng√†y
                                    {% else %}
                                    ƒê√£ h·∫øt h·∫°n
                                    {% endif %}
                                </a></li>
                                {% endwith %}
                                {% endif %}
                                {% endif %}
                                <li><hr class="dropdown-divider" style="margin: 8px 0;"></li>
                                <li><a class="dropdown-item" href="{% url 'logout' %}" style="border-radius: 8px; padding: 10px 16px; color: #dc2626;"><i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t</a></li>
                            </ul>
                        </li>
                    {% else %}
                        <li class="nav-item">
                            <a href="{% url 'home_login' %}" class="btn btn-primary" style="padding: 8px 24px; border-radius: 8px; font-weight: 600;">
                                <i class="fas fa-sign-in-alt"></i> ƒêƒÉng nh·∫≠p
                            </a>
                        </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    {% block content %}
    <!-- Hero Section -->
    <div class="hero-section">
        <div class="container">
            <div class="hero-content">
                {% if user.is_authenticated %}
                    <h1 class="hero-title">Xin ch√†o, {{ user.get_full_name|default:user.username }}! üëã</h1>
                    <p class="hero-subtitle">Kh√°m ph√° h√†ng ng√†n t√†i li·ªáu h·ªçc t·∫≠p ƒë∆∞·ª£c chia s·∫ª b·ªüi c·ªông ƒë·ªìng sinh vi√™n</p>
                {% else %}
                    <h1 class="hero-title">Ch√†o m·ª´ng ƒë·∫øn v·ªõi StudyBot! üìö</h1>
                    <p class="hero-subtitle">N·ªÅn t·∫£ng chia s·∫ª t√†i li·ªáu h·ªçc t·∫≠p h√†ng ƒë·∫ßu cho sinh vi√™n Vi·ªát Nam</p>
                {% endif %}
                
                <!-- Large Search Box with Autocomplete -->
                <form method="GET" action="{% url 'documents_search' %}" id="searchForm">
                    <div class="search-box-wrapper">
                        <div class="search-box-large">
                            <div class="input-group">
                                <input 
                                    type="text" 
                                    name="q" 
                                    id="searchInput"
                                    class="form-control" 
                                    placeholder="T√¨m ki·∫øm t√†i li·ªáu, m√¥n h·ªçc, tr∆∞·ªùng..." 
                                    value="{{ request.GET.q }}"
                                    autocomplete="off">
                                <button class="btn btn-primary" type="submit">
                                    <i class="fas fa-search"></i> T√¨m ki·∫øm
                                </button>
                            </div>
                        </div>
                        
                        <!-- Autocomplete Dropdown -->
                        <div id="autocompleteDropdown" class="autocomplete-dropdown"></div>
                    </div>
                </form>
                
                <!-- Hero Stats -->
                <div class="hero-stats">
                    <div class="hero-stat-item">
                        <span class="hero-stat-number">{{ universities.count|default:0 }}</span>
                        <span class="hero-stat-label">Tr∆∞·ªùng ƒê·∫°i H·ªçc</span>
                    </div>
                    <div class="hero-stat-item">
                        <span class="hero-stat-number">{{ documents.count|default:0 }}+</span>
                        <span class="hero-stat-label">T√†i Li·ªáu</span>
                    </div>
                    <div class="hero-stat-item">
                        <span class="hero-stat-number">10K+</span>
                        <span class="hero-stat-label">Sinh Vi√™n</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        <!-- Messages -->
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags|default:'info' }} alert-dismissible fade show" role="alert">
                    <i class="fas fa-{% if message.tags == 'success' %}check-circle{% elif message.tags == 'error' %}exclamation-circle{% else %}info-circle{% endif %}"></i>
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}

        <!-- User Stats Compact (only for authenticated users) -->
        {% if user.is_authenticated %}
        <div class="user-stats-compact">
            <h5 class="mb-3"><i class="fas fa-chart-line text-primary"></i> Ho·∫°t ƒë·ªông c·ªßa b·∫°n</h5>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-icon text-primary"><i class="fas fa-file-alt"></i></div>
                    <span class="stat-number">{{ user_documents_count|default:0 }}</span>
                    <div class="stat-label">T√†i li·ªáu ƒë√£ t·∫£i</div>
                </div>
                <div class="stat-item">
                    <div class="stat-icon text-success"><i class="fas fa-download"></i></div>
                    <span class="stat-number">{{ user_total_downloads|default:0 }}</span>
                    <div class="stat-label">L∆∞·ª£t t·∫£i xu·ªëng</div>
                </div>
                <div class="stat-item">
                    <div class="stat-icon text-info"><i class="fas fa-heart"></i></div>
                    <span class="stat-number">{{ user_total_likes|default:0 }}</span>
                    <div class="stat-label">L∆∞·ª£t th√≠ch</div>
                </div>
                <div class="stat-item">
                    <div class="stat-icon text-warning"><i class="fas fa-trophy"></i></div>
                    <span class="stat-number">0</span>
                    <div class="stat-label">Quiz ho√†n th√†nh</div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Quick Actions -->
        <div class="quick-actions">
            <div class="row g-4">
                <div class="col-lg-3 col-md-6 stagger-item">
                    <div class="action-card" onclick="window.location.href='{% if user.is_authenticated %}{% url 'upload_step1' %}{% else %}{% url 'home_login' %}{% endif %}'">
                        <div class="action-icon primary">
                            <i class="fas fa-upload"></i>
                        </div>
                        <div class="action-title">T·∫£i l√™n t√†i li·ªáu</div>
                        <div class="action-description">Chia s·∫ª t√†i li·ªáu v·ªõi c·ªông ƒë·ªìng</div>
                        <button class="btn btn-primary btn-sm">
                            {% if user.is_authenticated %}
                                <i class="fas fa-plus"></i> T·∫£i l√™n
                            {% else %}
                                <i class="fas fa-sign-in-alt"></i> ƒêƒÉng nh·∫≠p
                            {% endif %}
                        </button>
                    </div>
                </div>
                
                <div class="col-lg-3 col-md-6 stagger-item">
                    <div class="action-card" onclick="window.location.href='{% url 'documents_list' %}'">
                        <div class="action-icon success">
                            <i class="fas fa-book-open"></i>
                        </div>
                        <div class="action-title">Kh√°m ph√° t√†i li·ªáu</div>
                        <div class="action-description">T√¨m ki·∫øm trong kho t√†i li·ªáu</div>
                        <button class="btn btn-success btn-sm">
                            <i class="fas fa-arrow-right"></i> Kh√°m ph√°
                        </button>
                    </div>
                </div>
                
                <div class="col-lg-3 col-md-6 stagger-item">
                    <div class="action-card" onclick="window.location.href='{% url 'chat_rooms_list' %}'">
                        <div class="action-icon info">
                            <i class="fas fa-comments"></i>
                        </div>
                        <div class="action-title">Ph√≤ng chat</div>
                        <div class="action-description">Th·∫£o lu·∫≠n v·ªõi sinh vi√™n</div>
                        <button class="btn btn-info btn-sm">
                            <i class="fas fa-arrow-right"></i> Tham gia
                        </button>
                    </div>
                </div>
                
                <div class="col-lg-3 col-md-6 stagger-item">
                    <div class="action-card" onclick="window.location.href='{% url 'code_courses_list' %}'">
                        <div class="action-icon warning">
                            <i class="fas fa-code"></i>
                        </div>
                        <div class="action-title">Code with AI</div>
                        <div class="action-description">H·ªçc l·∫≠p tr√¨nh v·ªõi AI</div>
                        <button class="btn btn-warning btn-sm">
                            <i class="fas fa-arrow-right"></i> H·ªçc ngay
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Explore Universities Link -->
        <div class="row mb-4">
            <div class="col-12">
                <a href="#" onclick="showUniversitiesSection(); return false;" class="explore-link">
                    <div class="explore-icon">
                        <i class="fas fa-university"></i>
                    </div>
                    <div class="explore-title">Kh√°m ph√° theo tr∆∞·ªùng ƒë·∫°i h·ªçc</div>
                    <div class="explore-description">
                        T√¨m t√†i li·ªáu theo {{ universities.count|default:0 }} tr∆∞·ªùng ƒë·∫°i h·ªçc trong h·ªá th·ªëng
                    </div>
                    <div class="mt-3">
                        <span class="btn btn-outline-primary btn-sm">
                            <i class="fas fa-arrow-right"></i> Xem t·∫•t c·∫£ tr∆∞·ªùng
                        </span>
                    </div>
                </a>
            </div>
        </div>

        <!-- Latest Documents Section -->
        <div class="section-header">
            <h2 class="section-title"><i class="fas fa-star text-warning"></i> T√†i li·ªáu n·ªïi b·∫≠t</h2>
            <a href="{% url 'documents_list' %}" class="btn btn-outline-primary">
                <i class="fas fa-arrow-right"></i> Xem t·∫•t c·∫£
            </a>
        </div>

        <div class="row g-4 mb-5">
            {% if documents %}
                {% for document in documents|slice:":8" %}
                    <div class="col-lg-3 col-md-4 col-sm-6">
                        <div class="document-card" onclick="viewDocument({{ document.id }})">
                            <!-- Thumbnail -->
                            <div class="document-thumbnail">
                                {% if document.thumbnail %}
                                    <img src="{{ document.thumbnail.url }}" alt="{{ document.title }}">
                                {% else %}
                                    <div class="d-flex align-items-center justify-content-center h-100">
                                        <div class="text-center">
                                            {% if document.file_type == 'pdf' or document.file_type == 'application/pdf' %}
                                                <div class="file-icon pdf mx-auto">
                                                    <i class="fas fa-file-pdf"></i>
                                                </div>
                                            {% elif document.file_type == 'doc' or document.file_type == 'docx' or 'word' in document.file_type|lower %}
                                                <div class="file-icon doc mx-auto">
                                                    <i class="fas fa-file-word"></i>
                                                </div>
                                            {% elif document.file_type == 'xls' or document.file_type == 'xlsx' or 'excel' in document.file_type|lower %}
                                                <div class="file-icon xls mx-auto">
                                                    <i class="fas fa-file-excel"></i>
                                                </div>
                                            {% elif document.file_type == 'ppt' or document.file_type == 'pptx' or 'powerpoint' in document.file_type|lower %}
                                                <div class="file-icon ppt mx-auto">
                                                    <i class="fas fa-file-powerpoint"></i>
                                                </div>
                                            {% else %}
                                                <div class="file-icon txt mx-auto">
                                                    <i class="fas fa-file-alt"></i>
                                                </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endif %}
                            </div>

                            <!-- Document Type Badge -->
                            <div class="document-type-badge">
                                {% if document.document_type == 'textbook' %}S√°ch gi√°o khoa
                                {% elif document.document_type == 'exercise' %}B√†i t·∫≠p
                                {% elif document.document_type == 'exam' %}ƒê·ªÅ thi
                                {% elif document.document_type == 'thesis' %}Lu·∫≠n vƒÉn
                                {% elif document.document_type == 'lecture' %}B√†i gi·∫£ng
                                {% else %}Kh√°c
                                {% endif %}
                            </div>

                            <!-- Title -->
                            <div class="document-title">{{ document.title }}</div>

                            <!-- Meta Info -->
                            <div class="document-meta">
                                <div><i class="fas fa-university"></i> {{ document.university.short_name|default:document.university.name }}</div>
                                <div><i class="fas fa-user"></i> {{ document.uploaded_by.get_full_name|default:document.uploaded_by.username }}</div>
                            </div>

                            <!-- Stats -->
                            <div class="document-stats">
                                <div>
                                    <small><i class="fas fa-eye"></i> {{ document.view_count }}</small>
                                    <small class="ms-2"><i class="fas fa-download"></i> {{ document.download_count }}</small>
                                </div>
                                <div>
                                    <small><i class="fas fa-heart"></i> {{ document.like_count }}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div class="col-12">
                    <div class="text-center py-5">
                        <i class="fas fa-folder-open fa-4x text-muted mb-3" style="opacity: 0.3;"></i>
                        <h5>Ch∆∞a c√≥ t√†i li·ªáu n√†o</h5>
                        <p class="text-muted">H√£y b·∫Øt ƒë·∫ßu b·∫±ng c√°ch t·∫£i l√™n t√†i li·ªáu ƒë·∫ßu ti√™n!</p>
                        {% if user.is_authenticated %}
                        <button onclick="window.location.href='{% url 'upload_step1' %}'" class="btn btn-primary mt-3">
                            <i class="fas fa-upload"></i> T·∫£i l√™n t√†i li·ªáu
                        </button>
                        {% else %}
                        <button onclick="window.location.href='{% url 'home_login' %}'" class="btn btn-primary mt-3">
                            <i class="fas fa-sign-in-alt"></i> ƒêƒÉng nh·∫≠p ƒë·ªÉ t·∫£i l√™n
                        </button>
                        {% endif %}
                    </div>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Hidden Universities Section (shown when clicked) -->
    <div id="universitiesModal" style="display: none;">
        <div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1040;" onclick="hideUniversitiesSection()"></div>
        <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 15px; padding: 30px; max-width: 1200px; width: 90%; max-height: 80vh; overflow-y: auto; z-index: 1050; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3><i class="fas fa-university text-primary"></i> Ch·ªçn tr∆∞·ªùng ƒë·∫°i h·ªçc</h3>
                <button class="btn btn-sm btn-outline-secondary" onclick="hideUniversitiesSection()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="row g-4" id="universitiesContainer">
                {% if universities %}
                    {% for university in universities %}
                        <div class="col-lg-3 col-md-4 col-sm-6">
                            <div style="background: white; border: 2px solid #e5e7eb; border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.3s;" 
                                 onmouseover="this.style.borderColor='#6366f1'; this.style.transform='translateY(-2px)';" 
                                 onmouseout="this.style.borderColor='#e5e7eb'; this.style.transform='translateY(0)';" 
                                 onclick="window.location.href='{% url 'documents_list' %}?university={{ university.id }}'">
                                <div style="width: 60px; height: 60px; margin: 0 auto 15px; background: #f3f4f6; border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                                    {% if university.logo %}
                                        <img src="{{ university.logo.url }}" alt="{{ university.name }}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 10px;">
                                    {% else %}
                                        <i class="fas fa-university" style="font-size: 1.5rem; color: #6b7280;"></i>
                                    {% endif %}
                                </div>
                                <div style="font-weight: 600; margin-bottom: 5px;">{{ university.short_name|default:university.name }}</div>
                                <div style="font-size: 0.85rem; color: #6b7280;">{{ university.documents_count|default:0 }} t√†i li·ªáu</div>
                            </div>
                        </div>
                    {% endfor %}
                {% endif %}
            </div>
        </div>
    </div>

    {% endblock %}

    <!-- Footer -->
    <footer style="background: #1f2937; color: white; margin-top: 80px; padding: 60px 0 30px;">
        <div class="container">
            <div class="row g-4">
                <!-- About Section -->
                <div class="col-lg-4 col-md-6">
                    <h5 style="color: #fff; font-weight: 600; margin-bottom: 20px;">
                        <i class="fas fa-graduation-cap" style="color: #6366f1;"></i> StudyBot
                    </h5>
                    <p style="color: #9ca3af; line-height: 1.6; margin-bottom: 20px;">
                        N·ªÅn t·∫£ng chia s·∫ª t√†i li·ªáu h·ªçc t·∫≠p v√† h·ªçc l·∫≠p tr√¨nh v·ªõi AI h√†ng ƒë·∫ßu cho sinh vi√™n Vi·ªát Nam.
                    </p>
                    <div style="display: flex; gap: 12px;">
                        <a href="#" style="width: 40px; height: 40px; background: #374151; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #9ca3af; text-decoration: none; transition: all 0.3s;"
                           onmouseover="this.style.background='#6366f1'; this.style.color='white'"
                           onmouseout="this.style.background='#374151'; this.style.color='#9ca3af'">
                            <i class="fab fa-facebook-f"></i>
                        </a>
                        <a href="#" style="width: 40px; height: 40px; background: #374151; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #9ca3af; text-decoration: none; transition: all 0.3s;"
                           onmouseover="this.style.background='#6366f1'; this.style.color='white'"
                           onmouseout="this.style.background='#374151'; this.style.color='#9ca3af'">
                            <i class="fab fa-youtube"></i>
                        </a>
                        <a href="#" style="width: 40px; height: 40px; background: #374151; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #9ca3af; text-decoration: none; transition: all 0.3s;"
                           onmouseover="this.style.background='#6366f1'; this.style.color='white'"
                           onmouseout="this.style.background='#374151'; this.style.color='#9ca3af'">
                            <i class="fab fa-github"></i>
                        </a>
                    </div>
                </div>
                
                <!-- Quick Links -->
                <div class="col-lg-2 col-md-6">
                    <h6 style="color: #fff; font-weight: 600; margin-bottom: 20px;">Li√™n K·∫øt</h6>
                    <ul style="list-style: none; padding: 0; margin: 0;">
                        <li style="margin-bottom: 12px;">
                            <a href="{% url 'dashboard' %}" style="color: #9ca3af; text-decoration: none; transition: color 0.3s;"
                               onmouseover="this.style.color='#6366f1'"
                               onmouseout="this.style.color='#9ca3af'">
                                <i class="fas fa-home" style="width: 20px;"></i> Trang ch·ªß
                            </a>
                        </li>
                        <li style="margin-bottom: 12px;">
                            <a href="{% url 'documents_list' %}" style="color: #9ca3af; text-decoration: none; transition: color 0.3s;"
                               onmouseover="this.style.color='#6366f1'"
                               onmouseout="this.style.color='#9ca3af'">
                                <i class="fas fa-file-alt" style="width: 20px;"></i> T√†i li·ªáu
                            </a>
                        </li>
                        <li style="margin-bottom: 12px;">
                            <a href="{% url 'code_courses_list' %}" style="color: #9ca3af; text-decoration: none; transition: color 0.3s;"
                               onmouseover="this.style.color='#6366f1'"
                               onmouseout="this.style.color='#9ca3af'">
                                <i class="fas fa-code" style="width: 20px;"></i> Kh√≥a h·ªçc
                            </a>
                        </li>
                        <li style="margin-bottom: 12px;">
                            <a href="{% url 'chat_rooms_list' %}" style="color: #9ca3af; text-decoration: none; transition: color 0.3s;"
                               onmouseover="this.style.color='#6366f1'"
                               onmouseout="this.style.color='#9ca3af'">
                                <i class="fas fa-comments" style="width: 20px;"></i> Ph√≤ng chat
                            </a>
                        </li>
                    </ul>
                </div>
                
                <!-- Support -->
                <div class="col-lg-3 col-md-6">
                    <h6 style="color: #fff; font-weight: 600; margin-bottom: 20px;">H·ªó Tr·ª£</h6>
                    <ul style="list-style: none; padding: 0; margin: 0;">
                        <li style="margin-bottom: 12px;">
                            <a href="#" style="color: #9ca3af; text-decoration: none; transition: color 0.3s;"
                               onmouseover="this.style.color='#6366f1'"
                               onmouseout="this.style.color='#9ca3af'">
                                <i class="fas fa-question-circle" style="width: 20px;"></i> H∆∞·ªõng d·∫´n
                            </a>
                        </li>
                        <li style="margin-bottom: 12px;">
                            <a href="#" style="color: #9ca3af; text-decoration: none; transition: color 0.3s;"
                               onmouseover="this.style.color='#6366f1'"
                               onmouseout="this.style.color='#9ca3af'">
                                <i class="fas fa-envelope" style="width: 20px;"></i> Li√™n h·ªá
                            </a>
                        </li>
                        <li style="margin-bottom: 12px;">
                            <a href="#" style="color: #9ca3af; text-decoration: none; transition: color 0.3s;"
                               onmouseover="this.style.color='#6366f1'"
                               onmouseout="this.style.color='#9ca3af'">
                                <i class="fas fa-shield-alt" style="width: 20px;"></i> Ch√≠nh s√°ch
                            </a>
                        </li>
                        <li style="margin-bottom: 12px;">
                            <a href="#" style="color: #9ca3af; text-decoration: none; transition: color 0.3s;"
                               onmouseover="this.style.color='#6366f1'"
                               onmouseout="this.style.color='#9ca3af'">
                                <i class="fas fa-file-contract" style="width: 20px;"></i> ƒêi·ªÅu kho·∫£n
                            </a>
                        </li>
                    </ul>
                </div>
                
                <!-- Newsletter -->
                <div class="col-lg-3 col-md-6">
                    <h6 style="color: #fff; font-weight: 600; margin-bottom: 20px;">ƒêƒÉng K√Ω Nh·∫≠n Tin</h6>
                    <p style="color: #9ca3af; font-size: 0.9rem; margin-bottom: 16px;">
                        Nh·∫≠n th√¥ng b√°o v·ªÅ t√†i li·ªáu m·ªõi v√† kh√≥a h·ªçc
                    </p>
                    <div class="input-group" style="margin-bottom: 16px;">
                        <input type="email" class="form-control" placeholder="Email c·ªßa b·∫°n" style="background: #374151; border: 1px solid #4b5563; color: white; border-radius: 8px 0 0 8px;">
                        <button class="btn" style="background: #6366f1; color: white; border-radius: 0 8px 8px 0; border: none;">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                    <style>
                        footer input::placeholder {
                            color: rgba(255, 255, 255, 0.6) !important;
                        }
                    </style>
                </div>
            </div>
            
            <!-- Bottom Bar -->
            <div style="border-top: 1px solid #374151; margin-top: 40px; padding-top: 24px;">
                <div class="row align-items-center">
                    <div class="col-md-6 text-center text-md-start">
                        <p style="color: #9ca3af; margin: 0; font-size: 0.9rem;">
                            ¬© 2025 StudyBot. All rights reserved.
                        </p>
                    </div>
                    <div class="col-md-6 text-center text-md-end">
                        <p style="color: #9ca3af; margin: 0; font-size: 0.9rem;">
                            Made with <i class="fas fa-heart" style="color: #ef4444;"></i> for Vietnamese students
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Auto-hide alerts after 5 seconds
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                const alerts = document.querySelectorAll('.alert:not(.alert-permanent)');
                alerts.forEach(alert => {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                });
            }, 5000);
        });

        // View document function
        function viewDocument(documentId) {
            window.location.href = `/documents/${documentId}/view/`;
        }

        // Show universities section
        function showUniversitiesSection() {
            document.getElementById('universitiesModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        // Hide universities section
        function hideUniversitiesSection() {
            document.getElementById('universitiesModal').style.display = 'none';
            document.body.style.overflow = 'auto';
        }

        // Close modal on Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                hideUniversitiesSection();
                hideAutocomplete();
            }
        });
        
        // Smart Search Autocomplete
        let searchTimeout = null;
        const searchInput = document.getElementById('searchInput');
        const autocompleteDropdown = document.getElementById('autocompleteDropdown');
        
        // Show autocomplete on focus (history & popular)
        searchInput.addEventListener('focus', function() {
            if (this.value.trim() === '') {
                fetchSuggestionsEmpty();
            }
        });
        
        // Real-time search as user types
        searchInput.addEventListener('input', function() {
            const query = this.value.trim();
            
            clearTimeout(searchTimeout);
            
            if (query === '') {
                fetchSuggestionsEmpty();
                return;
            }
            
            // Debounce 300ms
            searchTimeout = setTimeout(() => {
                fetchSuggestions(query);
            }, 300);
        });
        
        // Fetch suggestions when input is empty (show history & popular)
        function fetchSuggestionsEmpty() {
            fetch('/api/search/suggestions/')
                .then(res => res.json())
                .then(data => {
                    renderHistoryAndPopular(data);
                })
                .catch(err => console.error('Error fetching suggestions:', err));
        }
        
        // Fetch real-time suggestions
        function fetchSuggestions(query) {
            fetch(`/api/search/suggestions/?q=${encodeURIComponent(query)}`)
                .then(res => res.json())
                .then(data => {
                    renderSuggestions(data);
                })
                .catch(err => console.error('Error fetching suggestions:', err));
        }
        
        // Render history and popular searches
        function renderHistoryAndPopular(data) {
            let html = '';
            
            // Search history
            if (data.history && data.history.length > 0) {
                html += `
                    <div class="autocomplete-section">
                        <div class="autocomplete-header"><i class="fas fa-history"></i> L·ªãch s·ª≠ t√¨m ki·∫øm</div>
                `;
                
                data.history.forEach(query => {
                    html += `
                        <div class="autocomplete-item" onclick="selectQuery('${escapeHtml(query)}')">
                            <div class="autocomplete-icon history">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="autocomplete-content">
                                <div class="autocomplete-title">${escapeHtml(query)}</div>
                            </div>
                            <div class="delete-history-icon" onclick="deleteHistoryItem(event, '${escapeHtml(query)}')" title="X√≥a">
                                <i class="fas fa-times"></i>
                            </div>
                        </div>
                    `;
                });
                
                // Add clear history button
                html += `
                    <button class="clear-history-btn" onclick="confirmClearHistory(event)">
                        <i class="fas fa-trash"></i> X√≥a l·ªãch s·ª≠ t√¨m ki·∫øm
                    </button>
                `;
                
                html += '</div>';
            }
            
            // Popular searches
            if (data.popular && data.popular.length > 0) {
                html += `
                    <div class="autocomplete-section">
                        <div class="autocomplete-header"><i class="fas fa-fire"></i> T√¨m ki·∫øm ph·ªï bi·∫øn</div>
                `;
                
                data.popular.forEach(query => {
                    html += `
                        <div class="autocomplete-item" onclick="selectQuery('${escapeHtml(query)}')">
                            <div class="autocomplete-icon history">
                                <i class="fas fa-search"></i>
                            </div>
                            <div class="autocomplete-content">
                                <div class="autocomplete-title">${escapeHtml(query)}</div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
            }
            
            if (html) {
                autocompleteDropdown.innerHTML = html;
                autocompleteDropdown.classList.add('show');
            } else {
                hideAutocomplete();
            }
        }
        
        // Render real-time suggestions
        function renderSuggestions(data) {
            let html = '';
            let hasResults = false;
            
            // Documents
            if (data.documents && data.documents.length > 0) {
                hasResults = true;
                html += `
                    <div class="autocomplete-section">
                        <div class="autocomplete-header"><i class="fas fa-file-alt"></i> T√†i li·ªáu</div>
                `;
                
                data.documents.forEach(doc => {
                    html += `
                        <div class="autocomplete-item" onclick="window.location.href='${doc.url}'">
                            <div class="autocomplete-icon doc">
                                <i class="fas ${doc.icon}"></i>
                            </div>
                            <div class="autocomplete-content">
                                <div class="autocomplete-title">${escapeHtml(doc.title)}</div>
                                <div class="autocomplete-subtitle">${escapeHtml(doc.university)} ‚Ä¢ ${escapeHtml(doc.course)}</div>
                            </div>
                            <span class="autocomplete-badge">T√†i li·ªáu</span>
                        </div>
                    `;
                });
                
                html += '</div>';
            }
            
            // Courses
            if (data.courses && data.courses.length > 0) {
                hasResults = true;
                html += `
                    <div class="autocomplete-section">
                        <div class="autocomplete-header"><i class="fas fa-book"></i> M√¥n h·ªçc</div>
                `;
                
                data.courses.forEach(course => {
                    html += `
                        <div class="autocomplete-item" onclick="window.location.href='${course.url}'">
                            <div class="autocomplete-icon course">
                                <i class="fas ${course.icon}"></i>
                            </div>
                            <div class="autocomplete-content">
                                <div class="autocomplete-title">${escapeHtml(course.title)}</div>
                                <div class="autocomplete-subtitle">${escapeHtml(course.university)}</div>
                            </div>
                            <span class="autocomplete-badge">M√¥n h·ªçc</span>
                        </div>
                    `;
                });
                
                html += '</div>';
            }
            
            // Universities
            if (data.universities && data.universities.length > 0) {
                hasResults = true;
                html += `
                    <div class="autocomplete-section">
                        <div class="autocomplete-header"><i class="fas fa-university"></i> Tr∆∞·ªùng ƒë·∫°i h·ªçc</div>
                `;
                
                data.universities.forEach(uni => {
                    html += `
                        <div class="autocomplete-item" onclick="window.location.href='${uni.url}'">
                            <div class="autocomplete-icon uni">
                                <i class="fas ${uni.icon}"></i>
                            </div>
                            <div class="autocomplete-content">
                                <div class="autocomplete-title">${escapeHtml(uni.title)}</div>
                                ${uni.subtitle ? `<div class="autocomplete-subtitle">${escapeHtml(uni.subtitle)}</div>` : ''}
                            </div>
                            <span class="autocomplete-badge">Tr∆∞·ªùng</span>
                        </div>
                    `;
                });
                
                html += '</div>';
            }
            
            if (hasResults) {
                autocompleteDropdown.innerHTML = html;
                autocompleteDropdown.classList.add('show');
            } else {
                autocompleteDropdown.innerHTML = `
                    <div class="autocomplete-section">
                        <div style="text-align: center; padding: 20px; color: #6b7280;">
                            <i class="fas fa-search fa-2x mb-2" style="opacity: 0.3;"></i>
                            <p>Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ ph√π h·ª£p</p>
                        </div>
                    </div>
                `;
                autocompleteDropdown.classList.add('show');
            }
        }
        
        // Hide autocomplete
        function hideAutocomplete() {
            autocompleteDropdown.classList.remove('show');
        }
        
        // Select query from history/popular
        function selectQuery(query) {
            searchInput.value = query;
            document.getElementById('searchForm').submit();
        }
        
        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Delete single history item
        function deleteHistoryItem(event, query) {
            event.stopPropagation();
            
            fetch('/api/search/delete-history-item/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ query: query })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    // Refresh suggestions to show updated list
                    fetchSuggestionsEmpty();
                }
            })
            .catch(err => {
                console.error('Error deleting history item:', err);
            });
        }
        
        // Confirm and clear search history
        function confirmClearHistory(event) {
            event.stopPropagation();
            
            if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a to√†n b·ªô l·ªãch s·ª≠ t√¨m ki·∫øm?')) {
                clearSearchHistory();
            }
        }
        
        // Clear search history via API
        function clearSearchHistory() {
            fetch('/api/search/clear-history/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                }
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    // Hide autocomplete and show success message
                    hideAutocomplete();
                    searchInput.value = '';
                    
                    // Show success alert
                    const alert = document.createElement('div');
                    alert.className = 'alert alert-success alert-dismissible fade show';
                    alert.style.position = 'fixed';
                    alert.style.top = '20px';
                    alert.style.right = '20px';
                    alert.style.zIndex = '9999';
                    alert.innerHTML = `
                        <i class="fas fa-check-circle"></i> ${data.message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    `;
                    document.body.appendChild(alert);
                    
                    setTimeout(() => {
                        alert.remove();
                    }, 3000);
                } else {
                    alert('L·ªói: ' + data.message);
                }
            })
            .catch(err => {
                console.error('Error clearing history:', err);
                alert('C√≥ l·ªói x·∫£y ra khi x√≥a l·ªãch s·ª≠');
            });
        }
        
        // Get CSRF token from cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        
        // Close autocomplete when clicking outside
        document.addEventListener('click', function(e) {
            if (!searchInput.contains(e.target) && !autocompleteDropdown.contains(e.target)) {
                hideAutocomplete();
            }
        });
    </script>
    
</body>
</html>